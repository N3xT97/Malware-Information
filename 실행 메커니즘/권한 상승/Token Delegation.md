### Concept

악성 코드는 특정 프로세스의 토큰을 위임 받아 사용하려고 시도함. 이 때 NtDuplicateToken를 호출할 때 ImpersonationLevel을 SecurityDelegation으로 설정해야 하고, TokenType은 TokenPrimary(기본 토큰)으로 설정해야 한다. TokenPrimary 타입으로 획득한 Token으로는 CreateProcessAsUserW에 전달하여 해당 Token의 권한으로 프로세스를 실행시킬 수 있음.
1. 타겟 프로세스의 pid를 획득
2. MAXIMUM_ALLOWED 권한으로 타겟 프로세스의 프로세스 핸들을 획득
3. SecurityDelegation와 TokenPrimary를 사용하여 NtDuplicateToken를 호출하여 token을 복제

### ZwOpenProcessToken

```C++
BOOL OpenProcessToken(
	[in] HANDLE ProcessHandle,
	[in] DWORD DesiredAccess,
	[out] PHANDLE TokenHandle
);
```

| Value     | DesiredAccess   |
| --------- | --------------- |
| 0x2000000 | MAXIMUM_ALLOWED |

### NtDuplicateToken

```C++
__kernel_entry NTSYSCALLAPI NTSTATUS NtDuplicateToken(
	[in] HANDLE ExistingTokenHandle,
	[in] ACCESS_MASK DesiredAccess,
	[in] POBJECT_ATTRIBUTES ObjectAttributes,
	[in] BOOLEAN EffectiveOnly,
	[in] TOKEN_TYPE TokenType,
	[out] PHANDLE NewTokenHandle
);
```

| Value     | ACCESS_MASK     |
| --------- | --------------- |
| 0x2000000 | MAXIMUM_ALLOWED |

| Value | TOKEN_TYPE   |
| ----- | ------------ |
| 0x1   | TokenPrimary |

### \_OBJECT_ATTRIBUTES

```C++
typedef struct _OBJECT_ATTRIBUTES {
  ULONG           Length;
  HANDLE          RootDirectory;
  PUNICODE_STRING ObjectName;
  ULONG           Attributes;
  PVOID           SecurityDescriptor;
  PVOID           SecurityQualityOfService;
} OBJECT_ATTRIBUTES;
```


### \_SECURITY_QUALITY_OF_SERVICE

```C++
typedef struct _SECURITY_QUALITY_OF_SERVICE {
  DWORD                          Length;
  SECURITY_IMPERSONATION_LEVEL   ImpersonationLevel;
  SECURITY_CONTEXT_TRACKING_MODE ContextTrackingMode;
  BOOLEAN                        EffectiveOnly;
} SECURITY_QUALITY_OF_SERVICE, *PSECURITY_QUALITY_OF_SERVICE;
```

| Value | SECURITY_IMPERSONATION_LEVEL |
| ----- | ---------------------------- |
| 0x3   | SecurityDelegation           |

### Example

```C++
_SECURITY_QUALITY_OF_SERVICE sqos;
_OBJECT_ATTRIBUTES oa;
_CLIENT_ID cid;
HANDLE h_process;
HANDLE h_target_token;
  
cid.UniqueProcess = target_pid;
cid.UniqueThread = NULL;
oa.Length = 0x18;
oa.RootDirectory = NULL;
oa.ObjectName = NULL;
oa.Attributes = 0x0;
oa.SecurityDescriptor = NULL;
oa.SecurityQualityOfService = NULL;
ZwOpenProcess(&h_target_process, MAXIMUM_ALLOWED, &oa,&cid);
ZwOpenProcessToken(h_target_process, TOKEN_QUERY, &h_target_token);

sqos.Length = 0xc;
sqos.ImpersonationLevel = SecurityDelegation;
sqos.ContextTrackingMode = '\0';
sqos.EffectiveOnly = '\0';
oa.Length = 0x18;
oa.RootDirectory = NULL;
oa.ObjectName = NULL;
oa.Attributes = 0x0;
oa.SecurityDescriptor = NULL;
oa.SecurityQualityOfService = &sqos;
NtDuplicateToken(h_target_token, MAXIMUM_ALLOWED, &oa, FALSE, TokenPrimary, &h_target_token_dup);

ZwClose(h_target_token);
ZwClose(h_target_process);
```