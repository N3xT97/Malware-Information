### Concept

프로세스에 전달된 설정 정보를 세팅
악성 코드는 악성 행위를 수행하기 전에 프로세스에 필요한 설정을 세팅함.

### Code Flow

1. 설정 정보를 세팅
2. NtSetInformationProcess API를 통해 전달

### NtSetInformationProcess

```c++
BOOL NtSetInformationProcess(
  [IN] HANDLE           _ProcessHandle_,
  [IN] PROCESSINFOCLASS _ProcessInformationClass_,
  [IN] PVOID            _ProcessInformation_,
  [IN] ULONG            _ProcessInformationLength_
);
```

### PROCESS_INFORMATION_CLASS

```c++
public enum PROCESSINFOCLASS
{
    ProcessBasicInformation = 0,
    ProcessQuotaLimits = 1,
    ProcessIoCounters = 2,
    ProcessVmCounters = 3,
    ProcessTimes = 4,
    ProcessBasePriority = 5,
    ProcessRaisePriority = 6,
    ProcessDebugPort = 7,
    ProcessExceptionPort = 8,
    ProcessAccessToken = 9,
    ProcessLdtInformation = 10,
    ProcessLdtSize = 11,
    ProcessDefaultHardErrorMode = 12,
    ProcessIoPortHandlers = 13,
    ProcessPooledUsageAndLimits = 14,
    ProcessWorkingSetWatch = 15,
    ProcessUserModeIOPL = 16,
    ProcessEnableAlignmentFaultFixup = 17,
    ProcessPriorityClass = 18,
    ProcessWx86Information = 19,
    ProcessHandleCount = 20,
    ProcessAffinityMask = 21,
    ProcessPriorityBoost = 22,
    ProcessDeviceMap = 23,
    ProcessSessionInformation = 24,
    ProcessForegroundInformation = 25,
    ProcessWow64Information = 26,
    ProcessImageFileName = 27,
    ProcessLUIDDeviceMapsEnabled = 28,
    ProcessBreakOnTermination = 29,
    ProcessDebugObjectHandle = 30,
    ProcessDebugFlags = 31,
    ProcessHandleTracing = 32,
    ProcessIoPriority = 33,
    ProcessExecuteFlags = 34,
    ProcessTlsInformation = 35,
    ProcessCookie = 36,
    ProcessImageInformation = 37,
    ProcessCycleTime = 38,
    ProcessPagePriority = 39,
    ProcessInstrumentationCallback = 40,
    ProcessThreadStackAllocation = 41,
    ProcessWorkingSetWatchEx = 42,
    ProcessImageFileNameWin32 = 43,
    ProcessImageFileMapping = 44,
    ProcessAffinityUpdateMode = 45,
    ProcessMemoryAllocationMode = 46,
    ProcessGroupInformation = 47,
    ProcessTokenVirtualizationEnabled = 48,
    ProcessOwnerInformation = 49,
    ProcessWindowInformation = 50,
    ProcessHandleInformation = 51,
    ProcessMitigationPolicy = 52,
    ProcessDynamicFunctionTableInformation = 53,
    ProcessHandleCheckingMode = 54,
    ProcessKeepAliveCount = 55,
    ProcessRevokeFileHandles = 56,
    ProcessWorkingSetControl = 57,
    ProcessHandleTable = 58,
    ProcessCheckStackExtentsMode = 59,
    ProcessCommandLineInformation = 60,
    ProcessProtectionInformation = 61,
    ProcessMemoryExhaustion = 62,
    ProcessFaultInformation = 63,
    ProcessTelemetryIdInformation = 64,
    ProcessCommitReleaseInformation = 65,
    ProcessReserved1Information = 66,
    ProcessReserved2Information = 67,
    ProcessSubsystemProcess = 68,
    ProcessInPrivate = 70,
    ProcessRaiseUMExceptionOnInvalidHandleClose = 71,
    ProcessSubsystemInformation = 75,
    ProcessWin32kSyscallFilterInformation = 79,
    ProcessEnergyTrackingState = 82,
    MaxProcessInfoClass = 83,
}
```

#### ProcessIoPriority(not correct)
```
Very Low: 0
Low: 1
Normal: 2
High: 3 or above?
```

#### ProcessPriorityClass
```c++
typedef struct _PROCESS_PRIORITY_CLASS {
	BOOLEAN Foreground;
	UCHAR PriorityClass;
} PROCESS_PRIORIY_CLASS, *PROCESS_PRIORIY_CLASS;

#define PROCESS_PRIORITY_CLASS_UNKNOWN 0
#define PROCESS_PRIORITY_CLASS_IDLE 1
#define PROCESS_PRIORITY_CLASS_NORMAL 2
#define PROCESS_PRIORITY_CLASS_HIGH 3
#define PROCESS_PRIORITY_CLASS_REALTIME 4
#define PROCESS_PRIORITY_CLASS_BELOW_NORMAL 5
#define PROCESS_PRIORITY_CLASS_ABOVE_NORMAL 6
```

#### ProcessDefaultHardErrorMode
```c++
public enum THREAD_ERROR_MODE : uint  
{  
    SEM_ALL_ERRORS = 0u,
    SEM_FAILCRITICALERRORS = 1u,
    SEM_NOGPFAULTERRORBOX = 2u,
    SEM_NOOPENFILEERRORBOX = 0x8000u,
    SEM_NOALIGNMENTFAULTEXCEPT = 4u
}
```

| Value  | THREAD_ERROR_MODE          | Description                                                                         |
| ------ | -------------------------- | ----------------------------------------------------------------------------------- |
| 0x0    | SEM_ALL_ERRORS             | 모든 오류 대화 상자를 표시하는 시스템 기본값을 사용.                                                      |
| 0x1    | SEM_FAILCRITICALERRORS     | 시스템에 심각한 오류 처리기 메시지 상자가 표시되지 않음.<br>대신 시스템은 호출 프로세스에 오류를 보냄.                        |
| 0x2    | SEM_NOGPFAULTERRORBOX      | 시스템에서 Windows 오류 보고를 호출하지 않음.                                                       |
| 0x4    | SEM_NOALIGNMENTFAULTEXCEPT | 시스템은 자동으로 메모리 맞춤 오류를 수정하고 애플리케이션에 보이지 않게 만듦.<br>호출 프로세스 및 모든 하위 프로세스에 대해 이 작업을 수행함. |
| 0x8000 | SEM_NOOPENFILEERRORBOX     | OpenFile 함수는 파일을 찾지 못하면 메시지 상자를 표시하지 않음.<br>대신 오류가 호출자에게 반환됨.                       |

### Example

```c++
*ProcessInformation = 0x3;
NtSetInformationProcess(0xffffffff, ProcessIoPriority, ProcessInformation, 0x4);

*ProcessInformation = *ProcessInformation << 0x9;
// 0x600인데 _PROCESS_PRIORITY_CLASS 구조체를 적용하면 PriorityClass가 0x6임
NtSetInformationProcess(0xffffffff, ProcessPriorityClass, ProcessInformation, 0x2);

*ProcessInformation = 0x7;
NtSetInformationProcess(0xffffffff, ProcessDefaultHardErrorMode, ProcessInformation, 0x4);
```

