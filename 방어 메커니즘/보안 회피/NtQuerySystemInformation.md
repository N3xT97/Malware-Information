

## SystemCodeIntegrityInformation (0x67)

- SYSTEM_CODEINTEGRITY_INFORMATION - winternl.h

```C++
typedef struct _SYSTEM_CODEINTEGRITY_INFORMATION {
	ULONG Length;
	ULONG CodeIntegrityOptions;
} SYSTEM_CODEINTEGRITY_INFORMATION, *PSYSTEM_CODEINTEGRITY_INFORMATION;
```

- CodeIntegrityOptions - winternl.h

```C++
\#define CODEINTEGRITY_OPTION_ENABLED                      0x0001
\#define CODEINTEGRITY_OPTION_TESTSIGN                     0x0002
\#define CODEINTEGRITY_OPTION_UMCI_ENABLED                 0x0004
\#define CODEINTEGRITY_OPTION_UMCI_AUDITMODE_ENABLED       0x0008
\#define CODEINTEGRITY_OPTION_UMCI_EXCLUSIONPATHS_ENABLED  0x0010
\#define CODEINTEGRITY_OPTION_TEST_BUILD                   0x0020
\#define CODEINTEGRITY_OPTION_PREPRODUCTION_BUILD          0x0040
\#define CODEINTEGRITY_OPTION_DEBUGMODE_ENABLED            0x0080
\#define CODEINTEGRITY_OPTION_FLIGHT_BUILD                 0x0100
\#define CODEINTEGRITY_OPTION_FLIGHTING_ENABLED            0x0200
\#define CODEINTEGRITY_OPTION_HVCI_KMCI_ENABLED            0x0400
\#define CODEINTEGRITY_OPTION_HVCI_KMCI_AUDITMODE_ENABLED  0x0800
\#define CODEINTEGRITY_OPTION_HVCI_KMCI_STRICTMODE_ENABLED 0x1000
\#define CODEINTEGRITY_OPTION_HVCI_IUM_ENABLED             0x2000
```


- NtQuerySystemInformation은 SYSTEM_CODEINTEGRITY_INFORMATION 구조체를 반환
- Sandbox의 경우, Window10에서의 커널 디버깅을 위해 아래의 Flag가 설정되어 있는 경우가 존재
    - CODEINTEGRITY_OPTION_TESTSIGN
    - CODEINTEGRITY_OPTION_DEBUGMODE_ENABLED

```C++
SYSTEM_CODEINTEGRITY_INFORMATION SCI;
SCI.Length = 0x8;
NtQuerySystemInformation(SystemCodeIntegrityInformation,&SCI,0x8,NULL);
if ((SCI.CodeIntegrityOptions & CODEINTEGRITY_OPTION_TESTSIGN) == 0x0 &&
      (SCI.CodeIntegrityOptions & CODEINTEGRITY_OPTION_DEBUGMODE_ENABLED) == 0x0) {
	// IsSandbox = flase
}
```