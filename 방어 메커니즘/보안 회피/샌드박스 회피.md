## 사용자 상호 작용 활용

샌드박스는 사용자의 개입 없이 악성 코드를 자동으로 분석하는 시스템. 멀웨어는 사용자의 개입이 없이 동작하는 샌드박스의 특성을 악용해 사용자의 실제 활동이 감지될 경우에만 활성화되도록 설계하여 샌드박스를 회피 가능. 사용자 활동이 감지되지 않으면 멀웨어는 샌드박스 환경에서 실행된다고 판단함.

- 메시지 창의 클릭
- 키보드 입력 확인
- 마우스 움직임 확인


## 샌드박스 아티팩트 탐지

업계에서 사용되는 다양한 샌드박스들은 일반적인 특징과 함께 고유한 특징을 가지고 있음. 

- 분석할 악성 코드 샘플의 파일명 (예: 샘플, 바이러스, 멀웨어)
- 분석할 악성 코드 샘플이 위치한 폴더 명
- 사용자 이름 (예: John, sandbox-user)
- 윈도우 제품키 `HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\ProductID`
	- Anubis = 76487-337-8429955-22614
	- Joe = 55274-640-2673064-23950

## 에이전트 감지

샌드박스에서는 분석 중인 실행 파일에 에이전트 Dll이 삽입됨. 이 에이전트 Dll은 실행 중인 샘플에서 호출되는 API를 모니터링하기 위해 주요 API들을 후킹함. 멀웨어는 메모리 내의 모듈과 Dll 목록을 검사해 이러한 에이전트 DLL들을 탐지. 또는 분석 환경에서 실행 중인 에이전트 프로세스를 탐지.

```rust
let module_names = [
	"sbiedll.dll",               // Sandboxie
	"aswhook.dll", "snxhk.dll"   // AVAST
];

let process_name = [
	"windanr.exe"                 // any-run
]
```


## 타이밍 공격

샌드박스 환경을 감지할 필요없이 샌드박스 환경을 피할 수 있는 공격. 특정 시간이나 특정 시간 이후에 멀웨어가 동작하는 방식. 샘플이 샌드박스 환경에서 영원히 실행될 수 없는 점을 이용. 샌드박스에게 주어진 시간 내에 악의적인 코드를 실행하지 않음으로써 샌드박스를 쉽게 회피.

- Sleep
- CreateWaitableTimer
- SetWaitableTimer
- WaitForSingleObject
- WaitForMultipleObject
- NtDelayExecution

최근 샌드박스들은 해당 API를 후킹하여 타이밍 공격을 무력화함.