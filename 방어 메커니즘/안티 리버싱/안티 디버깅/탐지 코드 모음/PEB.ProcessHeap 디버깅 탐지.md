### Description

ProcessHeap 필드에는 프로세스를 디버깅 중인지 판단할 수 있는 Flag와 ForeFlags라는 하위 필드가 존재.

- 32-bit Windows NT, Windows 2000 and Windows XP
	- `heap + 0x0C` = `Flags`
	- `heap + 0x10` = `ForceFlags`

- 32-bit Windows Vista and newer systems
	- `heap + 0x40` = `Flags`
	- `heap + 0x44` = `ForceFlags`

#### 프로세스가 디버깅 중이 아닌 경우

일반적으로 `Flags`는 `HEAP_GROWABLE (0x2)`로 `ForceFlags`는 `0`으로 세팅.

#### 프로세스가 디버깅 중인 경우

`Windows NT`, `Windows 2000` 이하 and 32-bit `Windows XP` 에서, `Flags` 필드는 아래와 같이 세팅.

- `HEAP_GROWABLE (0x2)`
- `HEAP_TAIL_CHECKING_ENABLED (0x20)`
- `HEAP_FREE_CHECKING_ENABLED (0x40)`
- `HEAP_SKIP_VALIDATION_CHECKS (0x10000000)`
- `HEAP_VALIDATE_PARAMETERS_ENABLED (0x40000000)`

64-bit Windows XP, and Windows Vista 이상에서, `Flags` 필드는 아래와 같이 세팅.

- `HEAP_GROWABLE (0x2)`
- `HEAP_TAIL_CHECKING_ENABLED (0x20)`
- `HEAP_FREE_CHECKING_ENABLED (0x40)`
- `HEAP_VALIDATE_PARAMETERS_ENABLED (0x40000000)`

시스템 환경과 상관 없이 `ForceFlags` 필드는 아래와 같이 세팅.

- `HEAP_TAIL_CHECKING_ENABLED (0x20)`
- `HEAP_FREE_CHECKING_ENABLED (0x40)`
- `HEAP_VALIDATE_PARAMETERS_ENABLED (0x40000000)`

### 예제 코드

```cpp
MOV EAX, FS:[0x30]                 // EAX에 PEB의 주소 저장
MOV EAX, [EAX + 0x18]              // EAX에 PEB.ProcessHeap 저장
CMP DWORD PTR DS:[EAX + 0x10], 0   // ForceFlags 필드 테스트를 통해,
                                   // 프로세스가 디버깅 중인지 확인
JMP ProcessIsBeingDebugged         // ZF가 0이면 점프
```