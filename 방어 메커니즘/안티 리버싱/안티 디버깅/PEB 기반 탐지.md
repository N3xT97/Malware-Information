## PEB

PEB, Process Environment Block는 현재 실행 중인 프로세스에 대한 정보를 담고 있는 구조체임. 만약 프로세스가 디버깅 중이라면 해당 구조체의 일부 필드가 변경됨. 멀웨어는 이 특징을 이용해 자신이 분석 환경에서 실행되고 있다고 탐지할 수 있음.

```c++
typedef struct _PEB32 {
	...
	BOOLEAN   BeingDebugged;   /* 0002 */
	...
	ULONG     ProcessHeap;     /* 0018 */
	...
	ULONG     NtGlobalFlag;    /* 0068 */
	...
} PEB32;
```

실행 중인 프로세스의 PEB 구조에 접근하기 위해서는 FS 세그먼트 레지스터를 사용. FS 레지스터는 TEB 주소를 가르키므로 `TEB[0x30]` 위치에 존재하는 PEB 구조체에 바로 접근할 수도 있음. 또한 TEB의 첫 번째 멤버인 TIB의 주소는 결국 TEB 주소임을 이용해, TIB 구조체의 Self 필드를 획득하여 접근할 수도 있음.

#### PEB 주소를 획득하는 코드

```C++
// 1. FS 레지스터를 통해 바로 접근
MOV EAX, FS:[0x30]

// 2. TEB 주소를 획득한 후 접근
MOV EAX, FS:[0x0]                     // TEB 주소 획득
MOV EAX, DWORD PTR DS:[EAX + 0x30]

// 3. TIB 주소를 획득한 후 접근
MOV EAX, FS:[0x18]                     // TIB 주소 획득
MOV EAX, DWORD PTR DS:[EAX + 0x30]
```

### PEB.BeingDebugged 디버깅 탐지

PEB.BeingDebugged(+0x2) 필드가 1로 설정된다면 프로세스가 디버깅 중임을 나타냄.


### PEB.ProcessHeap 디버깅 탐지

ProcessHeap 필드에는 프로세스를 디버깅 중인지 판단할 수 있는 Flag와 ForeFlags라는 하위 필드가 존재.

- 32-bit Windows NT, Windows 2000 and Windows XP
	- `heap + 0x0C` = `Flags`
	- `heap + 0x10` = `ForceFlags`

- 32-bit Windows Vista and newer systems
	- `heap + 0x40` = `Flags`
	- `heap + 0x44` = `ForceFlags`

#### 프로세스가 디버깅 중이 아닌 경우

일반적으로 `Flags`는 `HEAP_GROWABLE (0x2)`로 `ForceFlags`는 `0`으로 세팅.

#### 프로세스가 디버깅 중인 경우

`Windows NT`, `Windows 2000` 이하 and 32-bit `Windows XP` 에서, `Flags` 필드는 아래와 같이 세팅.

- `HEAP_GROWABLE (0x2)`
- `HEAP_TAIL_CHECKING_ENABLED (0x20)`
- `HEAP_FREE_CHECKING_ENABLED (0x40)`
- `HEAP_SKIP_VALIDATION_CHECKS (0x10000000)`
- `HEAP_VALIDATE_PARAMETERS_ENABLED (0x40000000)`

64-bit Windows XP, and Windows Vista 이상에서, `Flags` 필드는 아래와 같이 세팅.

- `HEAP_GROWABLE (0x2)`
- `HEAP_TAIL_CHECKING_ENABLED (0x20)`
- `HEAP_FREE_CHECKING_ENABLED (0x40)`
- `HEAP_VALIDATE_PARAMETERS_ENABLED (0x40000000)`

시스템 환경과 상관 없이 `ForceFlags` 필드는 아래와 같이 세팅.

- `HEAP_TAIL_CHECKING_ENABLED (0x20)`
- `HEAP_FREE_CHECKING_ENABLED (0x40)`
- `HEAP_VALIDATE_PARAMETERS_ENABLED (0x40000000)`

### PEB.NtGlobalFlags 디버깅 탐지

NtGlobalFlags 필드는 프로그램의 Heap 할당 방식을 정의함. Heap 할당은 디버깅 중일 때, 아래 특정 플래그들이 1로 설정됨.

- `FLG_HEAP_ENABLE_TAIL_CHECK   (0x10)`
- `FLG_HEAP_ENABLE_FREE_CHECK   (0x20)`
- `FLG_HEAP_VALIDATE_PARAMETERS (0x40)`

