## 가상 머신 아티팩트 탐지

VM의 게스트 OS에는 특정 가상화 소프트웨어 사용을 나타내는 프로세스, 파일, 레지스트리 등이 있을 수 있음. 분석용 VM 내부에 하이퍼바이저 소프트웨어에 의해 생성된 아티팩트들이 존재함. 멀웨어는 이 특징을 이용해 자신이 분석 환경에서 실행되고 있다고 탐지할 수 있음.


### VMware 아티팩트

```rust
// path = C:\\Windows\\system32\\drivers
let file_names = [
	"Vmmouse.sys", "vm3dver.dll", "vmtray.dll", "vm3dgl.dll", "vmdum.dll",
	"vmGuestLib.dll"
];
```

```rust
let module_names = [
	"vmci.sys", "vmusbmouse.sys", "vmmouse.sys", "vm3dmp.sys", "vmrawdsk.sys", "vmmemctl.sys" 
];
```

```rust
let process_names = [
	"vmacthlp.exe", "VGAuthService.exe", "vmwaretray.exe", "vmtoolsd.exe", "vboxtray.exe"
];
```

```rust
let service_names = [
	"VMTools", "Vmrawdsk", "Vmware Tools", "Vmxnet", "vmx_svga",
	"Vmmouse"
];
```

```rust
let registry_keys = [
	// 해당 키가 존재하는지 확인
	"HKLM\\SYSTEM\\ControlSet001\\Service\\vmware",
	"HKCU\\SOFTWARE\\VMware. Inc.\\VMware Tools",
	// 하위 키가 qemu, virtio, vbox, xen 문자열을 포함하는지 확인
	"HKLM\\SYSTEM\\CurrentControlSet\\Enum\\IDE",
	"HKLM\\SYSTEM\\CurrentControlSet\\Enum\\SCSI"
];
```


### Virtualbox  아티팩트

```rust
// path = C:\\Windows\\system32\\drivers
let file_names = [
	"VBoxMouse.sys", "VBoxGuest.sys", "VBoxVideo.sys", "vboxtray.exe", "vboxservice.exe",
	"VBoxControl.exe"
];
```

```rust
let module_names = [
	"VBoxGuest.sys", "VBoxSF.sys", "VBoxMouse.sys", "VBoxVideo.sys", "vboxdisp.sys" 
];
```

```rust
let process_names = [
	"vboxtray.exe", "vboxcontrol.exe", "vboxservice.exe", "vboxservice.exe"
];
```

```rust
let service_names = [
	"VBoxService", "VBoxGuest", "VBoxTray", "VBoxSF", "VBoxVideo",
	"VBoxMouse"
];
```

```rust
let registry_keys = [
	"HKLM\\SYSTEM\\ControlSet001\\Service\\VBoxService",
	"HKLM\\SYSTEM\\ControlSet001\\Service\\VBoxSF",
	"HKLM\\SOFTWARE\\Oracle\\VirtualBox Guest Additions",
	"HKLM\\HARDWARE\\ACPI\\DSDT\\VBOX_"
];
```


### KVM 아티팩트

```rust
let module_names = [
	"vioser.sys"
];
```

### QEMU 아티팩트

```rust
let process_name = [
	"qemu-ga.exe", "qga.exe",
];
```

### Parallels 아티팩트

```rust
let process_name = [
	"prl_tools.exe",
];
```

## 하드웨어 시뮬레이션 탐지

VM은 실제 하드웨어를 소프트웨어로 시뮬레이션하는 것. CPU, HDD, NIC, RAM 등은 물론이고 지원되는 명령어 세트까지 모두 기본 가상화 소프트웨어를 통해 시뮬레이션되어야 함. 멀웨어는 이러한 시뮬레이션 환경을 탐지하려고 시도.


### 프로세서 유형 감지

시스템의 CPU는 CPUID 명령어를 사용해 식별 가능. 

📑[***CPUID INFO***](https://en.wikipedia.org/wiki/CPUID)

CPUID 명령을 `EAX = 1`로 실행하면 CPU에 대한 여러 정보를 EAX, EBX, ECX, EDX 레지스터에 반환. 여기서 중요한 것은 ECX 레지스터의 31번째 비트.

- 31번째 비트 값이, 1이면 가상화 환경을 의미
- 31번째 비트 값이, 0이면 물리적 CPU를 의미

`EAX = 0x40000000`으로 설정한 상태에서 CPUID 명령을 실행하면 하이퍼바이저 ID 문자열을 EBX, ECX, EDX 레지스터에 반환됨.

- VMware: VMwareVMware이라는 문자열을 반환함.
- VirtualBox: VBoxVBoxVBox 문자열을 반환함.

### 네트워크 장치 감지

게스트 OS에 에뮬레이트된 NIC을 제공. 모든 NIC은 xx:xx:xx:xx:xx:xx 형식의 6바이트로 구성된 MAC 주소를 가지며, 하이퍼바이저는 처음 3바이트에 특정 패턴을 사용함. 멀웨어는 NIC의 MAC 주소 패턴을 분석해 시스템이 VM 환경인지 탐지하려고 시도.

- VMware: 00:0c:29, 00:1c:14, 00:05:69, 00:50:56
- VirtualBox: 08:00:27


### 통신 포트

IN 명령은 Ring 0에서만 실행되며, 실제 CPU의 커널 모드에서 작동함. 이 명령이 사용자 모드 애플리케이션에서 실행되면 실제 CPU인 경우 예외가 발생. 그러나 VMware 게스트 OS 내의 사용자 모드 애플리케이션에서 실행되면 EBX 레지스터에 VMware의 특별한 값을 반환함. 

- VMware = EBX를 0x564d5868(VMXh)로 설정