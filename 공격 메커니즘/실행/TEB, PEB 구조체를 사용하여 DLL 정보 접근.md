
### 1. TEB, Thread Environment Block

- TEB 정의 - winternl.h
    
    ```C++
    typedef struct _TEB32
    {
        NT_TIB32                     Tib;                               /* 0000 */
        ULONG                        EnvironmentPointer;                /* 001c */
        CLIENT_ID32                  ClientId;                          /* 0020 */
        ULONG                        ActiveRpcHandle;                   /* 0028 */
        ULONG                        ThreadLocalStoragePointer;         /* 002c */
        ULONG                        Peb;                               /* 0030 */
        ULONG                        LastErrorValue;                    /* 0034 */
        ULONG                        CountOfOwnedCriticalSections;      /* 0038 */
        ULONG                        CsrClientThread;                   /* 003c */
        ULONG                        Win32ThreadInfo;                   /* 0040 */
        ULONG                        User32Reserved[26];                /* 0044 */
        ULONG                        UserReserved[5];                   /* 00ac */
        ULONG                        WOW32Reserved;                     /* 00c0 */
        ULONG                        CurrentLocale;                     /* 00c4 */
        ULONG                        FpSoftwareStatusRegister;          /* 00c8 */
        ULONG                        ReservedForDebuggerInstrumentation[16]; /* 00cc */
        ULONG                        SystemReserved1[26];               /* 010c */
        char                         PlaceholderCompatibilityMode;      /* 0174 */
        BOOLEAN                      PlaceholderHydrationAlwaysExplicit;/* 0175 */
        char                         PlaceholderReserved[10];           /* 0176 */
        DWORD                        ProxiedProcessId;                  /* 0180 */
        ACTIVATION_CONTEXT_STACK32   ActivationContextStack;            /* 0184 */
        UCHAR                        WorkingOnBehalfOfTicket[8];        /* 019c */
        LONG                         ExceptionCode;                     /* 01a4 */
        ULONG                        ActivationContextStackPointer;     /* 01a8 */
        ULONG                        InstrumentationCallbackSp;         /* 01ac */
        ULONG                        InstrumentationCallbackPreviousPc; /* 01b0 */
        ULONG                        InstrumentationCallbackPreviousSp; /* 01b4 */
        BOOLEAN                      InstrumentationCallbackDisabled;   /* 01b8 */
        BYTE                         SpareBytes1[23];                   /* 01b9 */
        ULONG                        TxFsContext;                       /* 01d0 */
        ULONG                        GdiTebBatch[0x138];                /* 01d4 */
        CLIENT_ID32                  RealClientId;                      /* 06b4 */
        ULONG                        GdiCachedProcessHandle;            /* 06bc */
        ULONG                        GdiClientPID;                      /* 06c0 */
        ULONG                        GdiClientTID;                      /* 06c4 */
        ULONG                        GdiThreadLocaleInfo;               /* 06c8 */
        ULONG                        Win32ClientInfo[62];               /* 06cc */
        ULONG                        glDispatchTable[233];              /* 07c4 */
        ULONG                        glReserved1[29];                   /* 0b68 */
        ULONG                        glReserved2;                       /* 0bdc */
        ULONG                        glSectionInfo;                     /* 0be0 */
        ULONG                        glSection;                         /* 0be4 */
        ULONG                        glTable;                           /* 0be8 */
        ULONG                        glCurrentRC;                       /* 0bec */
        ULONG                        glContext;                         /* 0bf0 */
        ULONG                        LastStatusValue;                   /* 0bf4 */
        UNICODE_STRING32             StaticUnicodeString;               /* 0bf8 */
        WCHAR                        StaticUnicodeBuffer[261];          /* 0c00 */
        ULONG                        DeallocationStack;                 /* 0e0c */
        ULONG                        TlsSlots[64];                      /* 0e10 */
        LIST_ENTRY32                 TlsLinks;                          /* 0f10 */
        ULONG                        Vdm;                               /* 0f18 */
        ULONG                        ReservedForNtRpc;                  /* 0f1c */
        ULONG                        DbgSsReserved[2];                  /* 0f20 */
        ULONG                        HardErrorMode;                     /* 0f28 */
        ULONG                        Instrumentation[9];                /* 0f2c */
        GUID                         ActivityId;                        /* 0f50 */
        ULONG                        SubProcessTag;                     /* 0f60 */
        ULONG                        PerflibData;                       /* 0f64 */
        ULONG                        EtwTraceData;                      /* 0f68 */
        ULONG                        WinSockData;                       /* 0f6c */
        ULONG                        GdiBatchCount;                     /* 0f70 */
        ULONG                        IdealProcessorValue;               /* 0f74 */
        ULONG                        GuaranteedStackBytes;              /* 0f78 */
        ULONG                        ReservedForPerf;                   /* 0f7c */
        ULONG                        ReservedForOle;                    /* 0f80 */
        ULONG                        WaitingOnLoaderLock;               /* 0f84 */
        ULONG                        SavedPriorityState;                /* 0f88 */
        ULONG                        ReservedForCodeCoverage;           /* 0f8c */
        ULONG                        ThreadPoolData;                    /* 0f90 */
        ULONG                        TlsExpansionSlots;                 /* 0f94 */
        ULONG                        MuiGeneration;                     /* 0f98 */
        ULONG                        IsImpersonating;                   /* 0f9c */
        ULONG                        NlsCache;                          /* 0fa0 */
        ULONG                        ShimData;                          /* 0fa4 */
        ULONG                        HeapVirtualAffinity;               /* 0fa8 */
        ULONG                        CurrentTransactionHandle;          /* 0fac */
        ULONG                        ActiveFrame;                       /* 0fb0 */
        ULONG                        FlsSlots;                          /* 0fb4 */
        ULONG                        PreferredLanguages;                /* 0fb8 */
        ULONG                        UserPrefLanguages;                 /* 0fbc */
        ULONG                        MergedPrefLanguages;               /* 0fc0 */
        ULONG                        MuiImpersonation;                  /* 0fc4 */
        USHORT                       CrossTebFlags;                     /* 0fc8 */
        USHORT                       SameTebFlags;                      /* 0fca */
        ULONG                        TxnScopeEnterCallback;             /* 0fcc */
        ULONG                        TxnScopeExitCallback;              /* 0fd0 */
        ULONG                        TxnScopeContext;                   /* 0fd4 */
        ULONG                        LockCount;                         /* 0fd8 */
        LONG                         WowTebOffset;                      /* 0fdc */
        ULONG                        ResourceRetValue;                  /* 0fe0 */
        ULONG                        ReservedForWdf;                    /* 0fe4 */
        ULONGLONG                    ReservedForCrt;                    /* 0fe8 */
        GUID                         EffectiveContainerId;              /* 0ff0 */
    } TEB32;
    ```
    

- 현재 실행 중인 Thread에 대한 정보를 담고 있는 구조체
- FS 레지스터는 TEB 구조체 주소가 저장되어 있으며, FS 레지스터를 사용해 그 멤버에 접근할 수 있음

### 2. PEB, Process Environment Block

- PEB 정의 - winternl.h
    
    ```C++
    typedef struct _PEB32
    {
        BOOLEAN                      InheritedAddressSpace;             /* 0000 */
        BOOLEAN                      ReadImageFileExecOptions;          /* 0001 */
        BOOLEAN                      BeingDebugged;                     /* 0002 */
        UCHAR                        ImageUsedLargePages : 1;           /* 0003 */
        UCHAR                        IsProtectedProcess : 1;
        UCHAR                        IsImageDynamicallyRelocated : 1;
        UCHAR                        SkipPatchingUser32Forwarders : 1;
        UCHAR                        IsPackagedProcess : 1;
        UCHAR                        IsAppContainer: 1;
        UCHAR                        IsProtectedProcessLight : 1;
        UCHAR                        IsLongPathAwareProcess : 1;
        ULONG                        Mutant;                            /* 0004 */
        ULONG                        ImageBaseAddress;                  /* 0008 */
        ULONG                        LdrData;                           /* 000c */
        ULONG                        ProcessParameters;                 /* 0010 */
        ULONG                        SubSystemData;                     /* 0014 */
        ULONG                        ProcessHeap;                       /* 0018 */
        ULONG                        FastPebLock;                       /* 001c */
        ULONG                        AtlThunkSListPtr;                  /* 0020 */
        ULONG                        IFEOKey;                           /* 0024 */
        ULONG                        ProcessInJob : 1;                  /* 0028 */
        ULONG                        ProcessInitializing : 1;
        ULONG                        ProcessUsingVEH : 1;
        ULONG                        ProcessUsingVCH : 1;
        ULONG                        ProcessUsingFTH : 1;
        ULONG                        ProcessPreviouslyThrottled : 1;
        ULONG                        ProcessCurrentlyThrottled : 1;
        ULONG                        ProcessImagesHotPatched : 1;
        ULONG                        ReservedBits0 : 24;
        ULONG                        KernelCallbackTable;               /* 002c */
        ULONG                        Reserved;                          /* 0030 */
        ULONG                        AtlThunkSListPtr32;                /* 0034 */
        ULONG                        ApiSetMap;                         /* 0038 */
        ULONG                        TlsExpansionCounter;               /* 003c */
        ULONG                        TlsBitmap;                         /* 0040 */
        ULONG                        TlsBitmapBits[2];                  /* 0044 */
        ULONG                        ReadOnlySharedMemoryBase;          /* 004c */
        ULONG                        SharedData;                        /* 0050 */
        ULONG                        ReadOnlyStaticServerData;          /* 0054 */
        ULONG                        AnsiCodePageData;                  /* 0058 */
        ULONG                        OemCodePageData;                   /* 005c */
        ULONG                        UnicodeCaseTableData;              /* 0060 */
        ULONG                        NumberOfProcessors;                /* 0064 */
        ULONG                        NtGlobalFlag;                      /* 0068 */
        LARGE_INTEGER                CriticalSectionTimeout;            /* 0070 */
        ULONG                        HeapSegmentReserve;                /* 0078 */
        ULONG                        HeapSegmentCommit;                 /* 007c */
        ULONG                        HeapDeCommitTotalFreeThreshold;    /* 0080 */
        ULONG                        HeapDeCommitFreeBlockThreshold;    /* 0084 */
        ULONG                        NumberOfHeaps;                     /* 0088 */
        ULONG                        MaximumNumberOfHeaps;              /* 008c */
        ULONG                        ProcessHeaps;                      /* 0090 */
        ULONG                        GdiSharedHandleTable;              /* 0094 */
        ULONG                        ProcessStarterHelper;              /* 0098 */
        ULONG                        GdiDCAttributeList;                /* 009c */
        ULONG                        LoaderLock;                        /* 00a0 */
        ULONG                        OSMajorVersion;                    /* 00a4 */
        ULONG                        OSMinorVersion;                    /* 00a8 */
        ULONG                        OSBuildNumber;                     /* 00ac */
        ULONG                        OSPlatformId;                      /* 00b0 */
        ULONG                        ImageSubSystem;                    /* 00b4 */
        ULONG                        ImageSubSystemMajorVersion;        /* 00b8 */
        ULONG                        ImageSubSystemMinorVersion;        /* 00bc */
        ULONG                        ActiveProcessAffinityMask;         /* 00c0 */
        ULONG                        GdiHandleBuffer[34];               /* 00c4 */
        ULONG                        PostProcessInitRoutine;            /* 014c */
        ULONG                        TlsExpansionBitmap;                /* 0150 */
        ULONG                        TlsExpansionBitmapBits[32];        /* 0154 */
        ULONG                        SessionId;                         /* 01d4 */
        ULARGE_INTEGER               AppCompatFlags;                    /* 01d8 */
        ULARGE_INTEGER               AppCompatFlagsUser;                /* 01e0 */
        ULONG                        ShimData;                          /* 01e8 */
        ULONG                        AppCompatInfo;                     /* 01ec */
        UNICODE_STRING32             CSDVersion;                        /* 01f0 */
        ULONG                        ActivationContextData;             /* 01f8 */
        ULONG                        ProcessAssemblyStorageMap;         /* 01fc */
        ULONG                        SystemDefaultActivationData;       /* 0200 */
        ULONG                        SystemAssemblyStorageMap;          /* 0204 */
        ULONG                        MinimumStackCommit;                /* 0208 */
        ULONG                        FlsCallback;                       /* 020c */
        LIST_ENTRY32                 FlsListHead;                       /* 0210 */
        ULONG                        FlsBitmap;                         /* 0218 */
        ULONG                        FlsBitmapBits[4];                  /* 021c */
        ULONG                        FlsHighIndex;                      /* 022c */
        ULONG                        WerRegistrationData;               /* 0230 */
        ULONG                        WerShipAssertPtr;                  /* 0234 */
        ULONG                        pUnused;                           /* 0238 */
        ULONG                        pImageHeaderHash;                  /* 023c */
        ULONG                        HeapTracingEnabled : 1;            /* 0240 */
        ULONG                        CritSecTracingEnabled : 1;
        ULONG                        LibLoaderTracingEnabled : 1;
        ULONG                        SpareTracingBits : 29;
        ULONGLONG                    CsrServerReadOnlySharedMemoryBase; /* 0248 */
        ULONG                        TppWorkerpListLock;                /* 0250 */
        LIST_ENTRY32                 TppWorkerpList;                    /* 0254 */
        ULONG                        WaitOnAddressHashTable [0x80];     /* 025c */
        ULONG                        TelemetryCoverageHeader;           /* 045c */
        ULONG                        CloudFileFlags;                    /* 0460 */
        ULONG                        CloudFileDiagFlags;                /* 0464 */
        CHAR                         PlaceholderCompatibilityMode;      /* 0468 */
        CHAR                         PlaceholderCompatibilityModeReserved[7]; /* 0469 */
        ULONG                        LeapSecondData;                    /* 0470 */
        ULONG                        LeapSecondFlags;                   /* 0474 */
        ULONG                        NtGlobalFlag2;                     /* 0478 */
    } PEB32;
    ```
    

- 현재 실행 중인 Process에 대한 정보를 담고 있는 구조체
- TEB[0x30] 위치에 PEB 구조체의 주소가 저장되어 있음
- FS:[0x30]명령어를 통해 PEB 구조체 주소를 획득할 수 있음

### 3. PEB_LDR_DATA

- PEB_LDR_DATA 정의 - winternl.h
    
    ```C++
    typedef struct _PEB_LDR_DATA32
    {
        ULONG               Length;                             /* 000 */
        BOOLEAN             Initialized;                        /* 004 */
        ULONG               SsHandle;                           /* 008 */
        LIST_ENTRY32        InLoadOrderModuleList;              /* 00C */
        LIST_ENTRY32        InMemoryOrderModuleList;            /* 014 */
        LIST_ENTRY32        InInitializationOrderModuleList;    /* 01C */
        ULONG               EntryInProgress;
        BOOLEAN             ShutdownInProgress;
        ULONG               ShutdownThreadId;
    } PEB_LDR_DATA32, *PPEB_LDR_DATA32;
    ```
    

- PEB[0xC] 위치에 PEB_LDR_DATA 구조체의 주소가 저장되어 있음
- PEB_LDR_DATA 구조체는 로드된 모듈들에 대한 정보를 담고 있음
    - InLoadOrderModuleList
        - PEB_LDR_DATA[0xC]에 위치
        - 로드된 순서 (첫 번째 모듈은 현재 실행 중인 이미지)
    - InMemoryOrderModuleList
        - PEB_LDR_DATA[0x14]에 위치
        - 메모리 상의 순서 (첫 번째 모듈은 현재 실행 중인 이미지)
    - InInitializationOrderModuleList
        - PEB_LDR_DATA[0x1C] 에 위치
        - 모듈의 초기화된 순서 (첫 번째 모듈은 현재 실행 중인 이미지가 아님)
- LIST_ENTRY구조체로 이루어진 각 ModuleList는 양방향 연결 리스트 구조를 가짐
    
    - Flink와 Blink는 LDR_DATA_TABLE_ENTRY 구조체 내부의 각 ModuleList의 주소를 저장하고 있음
    - 즉, InInitializationOrderModuleList의 Flink와 Blink는 LDR_DATA_TABLE_ENTRY 내의 InInitializationOrderModuleList의 주소를 저장하고 있음
    
    - LIST_ENTRY 정의 - winternl.h
        
        ```C++
        typedef struct _LIST_ENTRY32
        {
            ULONG Flink;
            ULONG Blink;
        } LIST_ENTRY32;
        ```
        
    
    ![IMG-TEB, PEB 구조체를 사용하여 DLL 정보 접근-20240818160224891.png](images/TEB,%20PEB%20구조체를%20사용하여%20DLL%20정보%20접근/IMG-TEB,%20PEB%20구조체를%20사용하여%20DLL%20정보%20접근-20240818160224891.png)
    

### 4. LDR_DATA_TABLE_ENTRY

- LDR_DATA_TABLE_ENTRY 정의 - winternl.h
    
    ```C++
    typedef struct _LDR_DATA_TABLE_ENTRY
    {
        LIST_ENTRY          InLoadOrderLinks;             /* 000 */
        LIST_ENTRY          InMemoryOrderLinks;           /* 008 */
        LIST_ENTRY          InInitializationOrderLinks;   /* 010 */
        void*               DllBase;                      /* 018 */
        void*               EntryPoint;                   /* 01C */ 
        ULONG               SizeOfImage;                  /* 020 */
        UNICODE_STRING      FullDllName;                  /* 024 */
        UNICODE_STRING      BaseDllName;                  /* 02C */
        ULONG               Flags;
        SHORT               LoadCount;
        SHORT               TlsIndex;
        LIST_ENTRY          HashLinks;
        ULONG               TimeDateStamp;
        HANDLE              ActivationContext;
        void*               Lock;
        LDR_DDAG_NODE*      DdagNode;
        LIST_ENTRY          NodeModuleLink;
        struct _LDRP_LOAD_CONTEXT *LoadContext;
        void*               ParentDllBase;
        void*               SwitchBackContext;
        RTL_BALANCED_NODE   BaseAddressIndexNode;
        RTL_BALANCED_NODE   MappingInfoIndexNode;
        ULONG_PTR           OriginalBase;
        LARGE_INTEGER       LoadTime;
        ULONG               BaseNameHashValue;
        LDR_DLL_LOAD_REASON LoadReason;
        ULONG               ImplicitPathOptions;
        ULONG               ReferenceCount;
    } LDR_DATA_TABLE_ENTRY, *PLDR_DATA_TABLE_ENTRY;
    ```
    

- PEB_LDR_DATA 구조체 내의 각 ModuleList 멤버를 통해 접근 가능
- 모듈에 대한 DllBase, EntryPoint, DllName, SizeOfImage 등의 모듈 정보를 담고 있음
- PEB_LDR_DATA 구조체와 동일하게 내부에 3가지 ModuleList가 존재
    - 각 ModulelList를 사용하여 다음 LDR_DATA_TABLE_ENTRY에 대한 접근이 가능

### 5. 예시 - Ntdll.dll의 DllBase 획득

```C++
MOV EAX, FS:[0x30]               -> PEB 구조체 주소 획득
MOV EBX, dword ptr [EAX + 0xC]   -> PEB_LDR_DATA 구조체 주소 획득
ADD EBX, 0x1C                    -> PEB_LDR_DATA 구조체 내의 InInitializationOrderModuleList 이자
																		LIST_ENTRY의 Flink의 주소 획득
MOV ECX, dword ptr [EBX]         -> InInitializationOrderModuleList의 Flink가 가르키는 Ntdll의
                                    LDR_DATA_TABLE_ENTRY의 InInitializationOrderModuleList 주소 획득
MOV EDX, dword ptr [ECX + 8]     -> InInitializationOrderModuleList는 0x10 오프셋이고
                                    DllBase의 경우 0x18 오프셋이므로 +0x8을 통해 DllBase 값을 획득
```