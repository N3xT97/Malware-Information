### ShellExecuteEx

- ShellExecuteExW 정의
    
    ```C++
    BOOL ShellExecuteExW(
      [in, out] SHELLEXECUTEINFOW *pExecInfo
    );
    ```
    
- SHELLEXECUTEINFOW 정의
    
    ```C++
    typedef struct _SHELLEXECUTEINFOW
    {
        DWORD cbSize;               // in, required, sizeof of this structure
        ULONG fMask;                // in, SEE_MASK_XXX values
        HWND hwnd;                  // in, optional
        LPCWSTR  lpVerb;            // in, optional when unspecified the default verb is choosen
        LPCWSTR  lpFile;            // in, either this value or lpIDList must be specified
        LPCWSTR  lpParameters;      // in, optional
        LPCWSTR  lpDirectory;       // in, optional
        int nShow;                  // in, required
        HINSTANCE hInstApp;         // out when SEE_MASK_NOCLOSEPROCESS is specified
        void *lpIDList;             // in, valid when SEE_MASK_IDLIST is specified, PCIDLIST_ABSOLUTE, for use with SEE_MASK_IDLIST & SEE_MASK_INVOKEIDLIST
        LPCWSTR  lpClass;           // in, valid when SEE_MASK_CLASSNAME is specified
        HKEY hkeyClass;             // in, valid when SEE_MASK_CLASSKEY is specified
        DWORD dwHotKey;             // in, valid when SEE_MASK_HOTKEY is specified
        union
        {
            HANDLE hIcon;           // not used
    \#if (NTDDI_VERSION >= NTDDI_WIN2K)
            HANDLE hMonitor;        // in, valid when SEE_MASK_HMONITOR specified
    \#endif // (NTDDI_VERSION >= NTDDI_WIN2K)
        } DUMMYUNIONNAME;
        HANDLE hProcess;            // out, valid when SEE_MASK_NOCLOSEPROCESS specified
    } SHELLEXECUTEINFOW, *LPSHELLEXECUTEINFOW;
    ```
    

- SHELLEXECUTEINFOW 구조체를 작성하여 ShellExecuteExW로 전달하여 실행
    - `cbSize = 0x3C` → 구조체의 크기
    - `lpVerb = u"runas"` → 관리자 권한으로 실행
    - `ExecInfo.lpFile = u"wmic"` → Windows Management Instrumentation Commad-line 유틸리티
    - `lpParameters = u”process call create \"(관리자 권한으로 실행하고자하는 프로세스)\"”`
    - `hwnd = GetForegroundWindow()` → 소유자 창에 대한 핸들

### 예시 - 자신을 관리자 권한으로 실행

```C++
// 자기 자신의 FilePath를 획득
GetModuleFileNameW(NULL,pFilePathW,0x104);

// lpParameters 문자열 구성
wsprintfW(pBuf,u"process call create \"%s\"", pFilePathW);

// ExecInfo 구조체 초기화 및 작성
SHELLEXECUTEINFOW ExecInfo;
RtlZeroMemory(&ExecInfo.cbSize,0x3c);
ExecInfo.cbSize = 0x3c;
ExecInfo.lpVerb = u"runas"
ExecInfo.lpFile = u"wmic"
ExecInfo.lpParameters = (LPCWSTR)pBuf;
ExecInfo.hwnd = GetForegroundWindow)();

// ShellExecuteExW 함수 호출
do {
	res = ShellExecuteExW(&pExecInfo);
} while (res == 0x0);
```