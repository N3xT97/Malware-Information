### Concept

악성 코드는 TrustInstaller의 토큰을 복제하여 더 높은 권한을 사용하려 함.
이때 TrustInstaller 서비스 프로세스의 pid가 필요함.

### Code Flow

1. OpenService를 호출하여 TrustInstaller 서비스 핸들 획득
2. QueryServiceStatusEx를 호출하여 서비스 정보 획득
3. 만약 서비스가 멈춘 상태라면 StartServiceW를 호출하여 시작
4. 다시 QueryServiceStatusEx를 호출하여 서비스 프로세스의 pid 획득

### SERVICE_STATUS_PROCESS

```c++
typedef struct _SERVICE_STATUS_PROCESS {
  DWORD dwServiceType;
  DWORD dwCurrentState;
  DWORD dwControlsAccepted;
  DWORD dwWin32ExitCode;
  DWORD dwServiceSpecificExitCode;
  DWORD dwCheckPoint;
  DWORD dwWaitHint;
  DWORD dwProcessId;
  DWORD dwServiceFlags;
} SERVICE_STATUS_PROCESS, *LPSERVICE_STATUS_PROCESS;
```

### Example

```c++
h_scm = OpenSCManagerW(NULL, NULL, SC_MANAGER_CONNECT);
h_sc = OpenServiceW(h_scm, "TrustedInstaller", SERVICE_START|SERVICE_QUERY_STATUS);

do {
	scsi.dwProcessId = 0x0;
	QueryServiceStatusEx(h_sc, SC_STATUS_PROCESS_INFO, &ssp, 0x24, &return_size);
	if (ssp.dwCurrentState != SERVICE_STOPPED) break;
	ret = StartServiceW(h_sc, 0x0, 0x0);
} while(ret);

CloseServiceHandle(h_sc);
CloseServiceHandle(h_scm);

return scsi.dwProcessId
```