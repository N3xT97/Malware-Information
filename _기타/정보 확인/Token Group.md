## CheckTokenMembership

### Concept

CheckTokenMembership을 사용하여 Token의 Administrators SID (S-1-5-32-544)을 체크
- 관리자 그룹에 속하는 경우, 0이 아닌 값을 반환
- 관리자 그룹에 속하지 않는 경우, 0을 반환

vista 이상에서는 CheckTokenMembership을 호출하는 경우 filtered token이 체크됨
- vista 이상부터 split token 모델을 사용하기 때문에
- user가 admin 그룹에 있어도 filtered token가 check 대상이므로 false를 반환함

위의 특징을 이용하면 vista 이상에서 관리자 권한으로 실행되었는지 여부를 알 수 있음.
- 관리자 권한으로 실행되면 unfiltered token을 체크하므로 true를 반환
- 관리자 권한으로 실행되지 않았다면 filtered token을 체크하므로 false를 반환


### CheckTokenMembership

```C++
BOOL CheckTokenMembership(
  [in, optional] HANDLE TokenHandle,
  [in]           PSID   SidToCheck,
  [out]          PBOOL  IsMember
);
```


### Example

```C++
CheckTokenMembership(NULL, &ADMINISTRATORS_SID, &is_member);
if (is_member) {
	// User in Administrators Group
	// Vista 이상에서는 Process Run as Admin
}
```

## ZwQueryInformationToken
### Ref

[MSDN_SID](https://learn.microsoft.com/ko-kr/windows-server/identity/ad-ds/manage/understand-security-identifiers)
[Wellknown_SID_Info](https://system32.eventsentry.com/codes/field/Well-known%20Security%20Identifiers%20(SIDs))
[Windows_Group_Info](https://renenyffenegger.ch/notes/Windows/user-account/group/index)

### Concept

User가 특정 Group에 속한 경우, 프로세스 TokenGroups 내에 Group SID가 존재.
1. ZwQueryInformationToken에 TokenGroups를 전달하여 TokenGroup을 조회.
2. 수동으로 SID가 존재하는지 확인.

`Administrators SID(S-1-5-32-544)`
- 빌트인 그룹.
- 운영 체제를 처음 설치한 후 그룹의 유일한 구성원은 관리자 계정입니다.
- 시스템이 도메인에 가입하면 도메인 관리자 그룹이 관리자 그룹에 추가됩니다.
- 서버가 도메인 컨트롤러가 되면 Enterprise Admins 그룹도 Administrators 그룹에 추가됩니다.

`Domain Admins SID(S-1-5-21-domain-512)`
- 구성원에게 도메인 관리 권한이 있는 글로벌 그룹입니다.
- 기본적으로 도메인 관리자 그룹은 도메인 컨트롤러를 포함하여 도메인에 가입한 모든 컴퓨터의 관리자 그룹의 구성원입니다.
- 즉, 도메인에 가입한 모든 컴퓨터의 Administrator 권한을 가진다.
- 도메인 관리자는 그룹의 모든 구성원이 작성한 개체의 기본 소유자입니다.

### ZwQueryInformationToken

```C++
NTSYSAPI NTSTATUS ZwQueryInformationToken(
  [in]  HANDLE                  TokenHandle,
  [in]  TOKEN_INFORMATION_CLASS TokenInformationClass,
  [out] PVOID                   TokenInformation,
  [in]  ULONG                   TokenInformationLength,
  [out] PULONG                  ReturnLength
);
```

| Value | TokenInformation |
| ----- | ---------------- |
| 0x2   | TokenGroups      |
### Example

```C++
uint group_count;
SID_AND_ATTRIBUTES *groups;
TOKEN_GROUPS *tg;

is_in_admin_group = 0x0;

ZwOpenProcessToken(0xffffffff,0x8,&token_handle);
ZwQueryInformationToken(token_handle,TokenGroups,&tg,0x4,&return_len);

tg = malloc(return_len);
ZwQueryInformationToken(token_handle,TokenGroups,tg,return_len,&return_len);
groups = tg->Groups;
group_count = tg->GroupCount;
do {
    if ((*(groups->Sid + 0x8) == 32) && (*(groups->Sid + 0xc) == 544)) {
        is_in_admin_group = 0x1;
        break;
    }
    groups = groups + 0x1;
    group_count = group_count - 0x1;
} while (group_count != 0x0);

free(tg);
ZwClose(token_handle);

if (is_in_admin_group) {
	// user in admin group
}
```