## LCID Ref

🔗 [***Windows Language Code Identifier (LCID) Reference***](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-lcid/70feba9f-294e-491e-b6eb-56532684c37f)


## GetKeyboardLayoutList

### Concept

- `GetKeyboardLayoutList`
	- nBuff를 0으로 함수를 호출하면 현재 시스템에 설치되어 있는 KeyboardLayout의 개수를 반환.
	- 반환된 nBuff를 사용하여 GetKeyboardLayoutList를 호출하면 KeyboardLayoutList를 반환.
- 실행 흐름
	1. nBuff를 0으로 GetKeyboardLayoutList를 호출하여 KeyboardLayout의 개수를 획득.
	2. 반환된 nBuff를 사용하여 GetKeyboardLayoutList를 호출하여 KeyboardLayoutList를 획득.
	3. 반환된 KeyboardLayoutList를 순회하며 Target LCID가 존재하는지 확인.

### GetKeyboardLayoutList

```C++
int GetKeyboardLayoutList(
  [in]  int nBuff,
  [out] HKL *lpList
);
```

### Example

```C++
n_kb_list = GetKeyboardLayoutList(0x0,NULL);
HKB *p_kb_list = NULL;
p_kb_list = malloc(sizeof(HKL) * nKBList);
n_kb_list = GetKeyboardLayoutList(nKBList,pKBList);

HKL target = 0x0412; // Korean
bool is_target = false;
int i = 0
do {
	if (*(pKBList + i) == Target) {
		IsTarget = true;
		break;
	}
} while(i < nKBList);
```


## GetUserDefaultLangID

### Concept

- GetUserDefaultLangID
	- 현재 기본으로 설정된 LANGID를 반환
- 실행 흐름
	1. GetUserDefaultLangID를 호출하여 lcid를 획득.
	2. 조건문을 사용하여 타겟인지 확인.

### GetUserDefaultLangID

```C++
LANGID GetUserDefaultLangID();
```

### Example

```C++
bool is_target = false;
LANGID lcid = GetUserDefaultLangID();

if (lcid == 0x412) {
	is_target = true;
}
```


## GetLocaleInfoA

### Concept

- GetLocaleInfoA
	- LCID 값을 전달하면 언어명을 획득 가능
- 실행 흐름
	1. GetUserDefaultLangID 등의 함수를 호출하여 LCID를 획득.
	2. LCID를 GetLocaleInfoA에 전달하여 언어명을 획득.
	3. 언어명을 서버로 전달.

### GetLocaleInfoA

```C++
int GetLocaleInfoA(
  [in]            LCID   Locale,
  [in]            LCTYPE LCType,
  [out, optional] LPSTR  lpLCData,
  [in]            int    cchData
);
```

| ***LCTYPE***     | ***value*** | ***Info***       |
| ---------------- | ----------- | ---------------- |
| LOCALE_SLANGUAGE | 0x2         | 미리 정의된 lcid의 언어명 |

### Example

```C++
char buf[260];
LANGID lcid = GetUserDefaultLangID();
GetLocaleInfoA(lcid, LOCALE_SLANGUAGE, buf, sizeof(buf));
```


## Registry

### Concept

#### "HKU\\(SID)\\Control Panel\\International"

| Value Name | Example |
| ---------- | ------- |
| LocaleName | ko-KR   |
| sLanguage  | KOR     |

### Code Flow

1. RegCreateKeyExW를 사용하여 "HKU\\(SID)\\Control Panel\\International" 키 핸들을 획득
2. RegQueryValueExW를 사용하여 "LocaleName", "sLanguage" 키 값을 확인

### RegCreateKeyExW

```c++
LSTATUS RegCreateKeyExW(
  [in]            HKEY                        hKey,
  [in]            LPCWSTR                     lpSubKey,
                  DWORD                       Reserved,
  [in, optional]  LPWSTR                      lpClass,
  [in]            DWORD                       dwOptions,
  [in]            REGSAM                      samDesired,
  [in, optional]  const LPSECURITY_ATTRIBUTES lpSecurityAttributes,
  [out]           PHKEY                       phkResult,
  [out, optional] LPDWORD                     lpdwDisposition
);
```

### RegQueryValueExW

```c++
LSTATUS RegQueryValueExW(
  [in]                HKEY    hKey,
  [in, optional]      LPCWSTR lpValueName,
                      LPDWORD lpReserved,
  [out, optional]     LPDWORD lpType,
  [out, optional]     LPBYTE  lpData,
  [in, out, optional] LPDWORD lpcbData
);
```

### Example

```c++
RegCreateKeyExW(HKEY_USERS, "(SID)\\Control Panel\\International",
				0x0, 0x0, 0x0, 0x20119, 0x0, &h_key, 0x0);
type = REG_SZ;
data_size = 0x10;
RegQueryValueExW(h_key, "LocaleName", 0x0, &type, locale_name_ptr, &data_size);
RegQueryValueExW(h_key, "sLanguage", 0x0, &type, s_language_ptr, &data_size);
```