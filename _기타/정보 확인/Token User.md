### Concept

악성 코드는 자기 자신을 서비스로 실행시켜서 Local System Account SID를 획득하여 더 높은 권한을 가지려고 한다. 프로세스가 Service로 실행되었을 경우, User의 SID는 `S-1-5-18`이 된다.
1. ZwOpenProcessToken를 사용하여 token을 획득.
2. ZwQueryInformationToken에 TokenUser를 전달하여 User SID를 확인.
3. 만약 SID가 `S-1-5-18` 라면 서비스로 실행되었다고 판단 가능.

`LocalSystem SID S-1-5-18`
- "NT AUTHORITY\\SYSTEM"
- 운영 체제와 로컬 시스템으로 로그인하도록 구성된 서비스에서 로컬로 사용되는 ID.
- 시스템은 관리자의 숨겨진 구성원.
- 즉, 시스템으로 실행되는 모든 프로세스는 액세스 토큰에 내장 관리자 그룹에 대한 SID를 가짐.

### ZwQueryInformationToken

```C++
NTSYSAPI NTSTATUS ZwQueryInformationToken(
  [in]  HANDLE                  TokenHandle,
  [in]  TOKEN_INFORMATION_CLASS TokenInformationClass,
  [out] PVOID                   TokenInformation,
  [in]  ULONG                   TokenInformationLength,
  [out] PULONG                  ReturnLength
);
```

| Value | TokenInformation |
| ----- | ---------------- |
| 0x1   | TokenUser        |
### TokenUser

```c++
typedef struct _TOKEN_USER {
	SID_AND_ATTRIBUTES User;
} TOKEN_USER, *PTOKEN_USER;
```

### Example

```C++
TOKEN_USER tu;

ZwOpenProcessToken(0xffffffff, 0x8, &h_token);
ZwQueryInformationToken(h_token, TokenUser, &tu, 0x2c, &return_len);
if (*(tu.User.Sid + 0x8) == 18) {
	is_run_as_svc = 0x1;
}
ZwClose(h_token);
```