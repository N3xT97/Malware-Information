## ZwQuerySystemInformation

### Concept

악성 코드는 특정 프로세스를 확인하기 위해서 실행 중인 프로세스들의 순회한다.

### CodeFlow

1. NtSetInformationThread를 호출하여 SYSTEM_PROCESS_INFORMATION 구조체 배열을 획득
2. NextEntryOffset 필드를 사용하여 SYSTEM_PROCESS_INFORMATION 구조체 배열을 순회
3. 필요한 프로세스 정보를 처리

### ZwQuerySystemInformation

```c++
NTSTATUS WINAPI ZwQuerySystemInformation(
  _In_      SYSTEM_INFORMATION_CLASS SystemInformationClass,
  _Inout_   PVOID                    SystemInformation,
  _In_      ULONG                    SystemInformationLength,
  _Out_opt_ PULONG                   ReturnLength
);
```

### SYSTEM_PROCESS_INFORMATION

```c++
typedef struct _SYSTEM_PROCESS_INFORMATION {
  ULONG                   _NextEntryOffset_;
  ULONG                   _NumberOfThreads_;
  LARGE_INTEGER           _Reserved[3]_;
  LARGE_INTEGER           _CreateTime_;
  LARGE_INTEGER           _UserTime_;
  LARGE_INTEGER           _KernelTime_;
  UNICODE_STRING          _ImageName_;
  KPRIORITY               _BasePriority_;
  HANDLE                  _ProcessId_;
  HANDLE                  _InheritedFromProcessId_;
  ULONG                   _HandleCount_;
  ULONG                   _Reserved2[2]_;
  ULONG                   _PrivatePageCount_;
  VM_COUNTERS             _VirtualMemoryCounters_;
  IO_COUNTERS             _IoCounters_;
  SYSTEM_THREAD           _Threads[0]_;
} SYSTEM_PROCESS_INFORMATION, *PSYSTEM_PROCESS_INFORMATION;
```

### Example

```c++
ULONG size = 0;
ZwQuerySystemInformation(SystemProcessInformation, NULL, 0, &size);
PSYSTEM_PROCESS_INFORMATION spi_ptr = (PSYSTEM_PROCESS_INFORMATION)malloc(size);
ZwQuerySystemInformation(SystemProcessInformation, spi_ptr, size, &size);
do {
    if (CalHash((pspi->ImageName).Buffer) == target_hash) {
	    pid = spi_iter->UniqueProcessId;
	    break;
    }
    spi_ptr += spi_ptr->NextEntryOffset;
} while (spi_ptr->NextEntryOffset != 0);
```