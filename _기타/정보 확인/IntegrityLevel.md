## GetTokenInformation

### Concept
- GetTokenInformation
	- 전달된 TokenInformationClass에 따라 반환하는 구조체가 달라짐.
	- TokenIntegrityLevel(0x19)를 전달하면 IntegrityLevel 정보 획득 가능.
- 실행 흐름
	1. OpenProcessToken을 호출하여 토큰 핸들을 획득.
	2. TokenIntegrityLevel(0x19)을 전달하여 GetTokenInformation을 호출.
	3. 획득한 TOKEN_MANDATORY_LABEL 구조체 멤버인 SID_AND_ATTRIBUTES.Attributes를 확인.

### OpenProcessToken

```C++
BOOL OpenProcessToken(
	[in]  HANDLE  ProcessHandle,
	[in]  DWORD   DesiredAccess,
	[out] PHANDLE TokenHandle
);
```

| Value | **Access-Token** |     |
| ----- | ---------------- | --- |
| 0x08  | TOKEN_QUERY      |     |

### GetTokenInformation

```C++
BOOL GetTokenInformation(
	[in]            HANDLE                  TokenHandle,
    [in]            TOKEN_INFORMATION_CLASS TokenInformationClass,
    [out, optional] LPVOID                  TokenInformation,
    [in]            DWORD                   TokenInformationLength,
    [out]           PDWORD                  ReturnLength
);
```

| Value | TOKEN_INFORMATION_CLASS | TokenInformation      |
| ----- | ----------------------- | --------------------- |
| 0x19  | TokenIntegrityLevel     | TOKEN_MANDATORY_LABEL |

### TOKEN_MANDATORY_LABEL

```C++
typedef struct _TOKEN_MANDATORY_LABEL {
	SID_AND_ATTRIBUTES Label;
} TOKEN_MANDATORY_LABEL, * PTOKEN_MANDATORY_LABEL;
```

### SID_AND_ATTRIBUTES

```C++
typedef struct _SID_AND_ATTRIBUTES {
\#ifdef MIDL_PASS
    PISID Sid;
\#else // MIDL_PASS
    PSID Sid;
\#endif // MIDL_PASS
    DWORD Attributes;
} SID_AND_ATTRIBUTES, * PSID_AND_ATTRIBUTES;
```

| Value      | **RID**                                  | Info       |
| ---------- | ---------------------------------------- | ---------- |
| 0x00000000 | SECURITY_MANDATORY_UNTRUSTED_RD          | 신뢰할 수 없는.  |
| 0x00001000 | SECURITY_MANDATORY_LOW_RID               | 낮은 무결성.    |
| 0x00002000 | SECURITY_MANDATORY_MEDIUM_RID            | 중간 무결성.    |
| 0x00002100 | SECURITY_MANDATORY_MEDIUM_PLUS_RID       | 중간 높은 무결성. |
| 0x00003000 | SECURITY_MANDATORY_HIGH_RID              | 높은 무결성.    |
| 0x00004000 | SECURITY_MANDATORY_SYSTEM_RID            | 시스템 무결성.   |
| 0x00005000 | SECURITY_MANDATORY_PROTECTED_PROCESS_RID | 보호된 프로세스   |

### Additional Info

- 크기를 0x14로 지정하면, PSID / 4byte 패딩 / SID 구조체가 온 다음 Attributes가 표기.
	- PSID는 구조체 내부를 포인팅하도록 구현되어 있기 때문.
	- 가장 처음에 PSID 멤버가 가장 마지막에 Attributes 멤버가 존재한다고 생각하면 편함.

![640](images/IntegrityLevel/IMG-IntegrityLevel-20240818160224772.png)

### Example

```C++
OpenProcessToken((HANDLE)0xffffffff, TOKEN_QUERY, &hToken);
GetTokenInformation(hToken, TokenIntegrityLevel, &TIL, 0x14, &TokenInformationLength);

if (TIL.Label.Attributes < SECURITY_MANDATORY_MEDIUM_RID) {
	// IntegrityLevel is lower than SECURITY_MANDATORY_MEDIUM_RID
}
```